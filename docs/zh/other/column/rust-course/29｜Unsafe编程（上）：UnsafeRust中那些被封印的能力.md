# 29ï½œUnsafeç¼–ç¨‹ï¼ˆä¸Šï¼‰ï¼š Unsafe Rustä¸­é‚£äº›è¢«å°å°çš„èƒ½åŠ›
ä½ å¥½ï¼Œæˆ‘æ˜¯Mikeã€‚

è¿™é—¨è¯¾ç›®å‰å·²æ¥è¿‘å°¾å£°ï¼Œå‰©ä¸‹çš„ä¸¤èŠ‚è¯¾æˆ‘å‡†å¤‡è®²è®²Rustä¸­çœ‹èµ·æ¥æœ‰ç‚¹é»‘é­”æ³•çš„éƒ¨åˆ†â€”â€”Unsafe Rustã€‚è¿™ä¸€èŠ‚è¯¾æˆ‘ä»¬å…ˆæ¥èŠèŠç›¸å…³çš„æ¦‚å¿µã€‚

åœ¨å‰é¢è¯¾ç¨‹çš„å­¦ä¹ ä¸­ï¼Œä½ æœ‰æ²¡æœ‰æ„Ÿè§‰åˆ°ï¼ŒRustç¼–è¯‘å™¨å°±åƒæ˜¯ä¸€ä¸ªä¸¥å‰çš„å¤§å¸ˆå‚…ï¼Œæˆ–è€…ä¸€ä¸ªè´´å¿ƒçš„å°åŠ©æ‰‹ï¼Œåœ¨ä½ èº«è¾¹é™ªä½ ç»“å¯¹ç¼–ç¨‹ï¼Œä½ å†™ä»£ç çš„æ—¶å€™ï¼Œä»–ç›¯ç€å±å¹•ï¼Œæ—¶ä¸æ—¶æé†’ä½ ã€‚å¦‚æœæŸä¸ªæ—¶åˆ»ï¼Œè¿™ä¸ªå¤§å¸ˆå‚…æˆ–å°åŠ©æ‰‹çªç„¶ç¦»å¼€äº†ï¼Œä½ ä¼šä¸ä¼šæ…Œï¼Ÿå°±åƒåˆšæè½¦ï¼Œç¬¬ä¸€æ¬¡ç‹¬è‡ªä¸Šè·¯çš„é‚£ç§æ„Ÿè§‰ã€‚

## ä¸‰ä¸ªç‹å›½

Unsafe Rust å°±æ˜¯è¿™æ ·ä¸€ä¸ªé¢†åŸŸï¼Œè¿›å…¥è¿™ä¸ªé¢†åŸŸï¼Œä½ çªç„¶æ‹¥æœ‰äº†å‡ ç§å¿…æ€æŠ€èƒ½ï¼Œä½†æ˜¯èº«è¾¹å·²ç»æ²¡æœ‰å¤§å¸ˆå‚…åŒè¡Œäº†ï¼Œåªèƒ½é ä½ è‡ªå·±å®Œå…¨æ§åˆ¶è¿™å‡ ç§æŠ€èƒ½çš„ä½¿ç”¨ã€‚ä½¿ç”¨å¾—å¥½ï¼Œå¨åŠ›æ— ç©·ã€‚ä½¿ç”¨ä¸å¥½ï¼Œå¯¹è‡ªå·±ä¹Ÿä¼šé€ æˆå·¨å¤§ä¼¤å®³ã€‚Unsafe Rustå°±æ˜¯è¿™æ ·ä¸€ä¸ªç›¸å¯¹ç‹¬ç«‹çš„é¢†åŸŸã€‚å‰é¢æˆ‘ä»¬è®²åˆ°è¿‡ï¼ŒAsync Rustä¹Ÿæ˜¯ç›¸å¯¹ç‹¬ç«‹çš„ä¸€ä¸ªé™„å±ç‹å›½ï¼Œç°åœ¨åˆå¤šäº†ä¸€ä¸ªUnsafe Rustè¿™æ ·çš„é™„å±ç‹å›½ã€‚

![å›¾ç‰‡](images/739345/f71d96faf019a6e0dc3f4291cf251f88.jpg)

Rustè¯­è¨€å¯ä»¥çœ‹ä½œæ˜¯è¿™ä¸‰å—ç–†åŸŸçš„åˆä½“ï¼Œå®ƒä»¬å…±åŒç»„æˆäº†ä¸€ä¸ªè”ç›ŸRustç‹å›½ã€‚ä½ ç”šè‡³å¯ä»¥æŠŠRustè¯­è¨€çœ‹æˆåŒ…å«ä¸Šé¢ä¸‰ç§ç¼–ç¨‹è¯­è¨€çš„ä¸€ç§æ··åˆè¯­è¨€ã€‚æ‰€ä»¥å¾ˆå¤šäººæŠ±æ€¨Rustéš¾å­¦ï¼Œä¹Ÿæ˜¯å¯ä»¥ç†è§£çš„ã€‚

ç°åœ¨è®©æˆ‘ä»¬æŠŠæ³¨æ„åŠ›é›†ä¸­åœ¨Unsafe Rustè¿™ä¸ªç‹å›½é‡Œé¢ã€‚å®ƒåˆ°åº•æ˜¯ä»€ä¹ˆæ ·çš„ï¼Ÿç®€å•åœ°è¯´ï¼Œä½ å¯ä»¥æŠŠå®ƒç†è§£æˆè¿™ä¸ªç‹å›½é‡Œé¢ä½ç€ä¸€ä¸ªCè¯­è¨€æ—çš„å›½ç‹ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼ŒCè¯­è¨€èƒ½åšçš„äº‹æƒ…ï¼ŒUnsafe Rustéƒ½èƒ½åšã€‚Cè¯­è¨€èƒ½åšå“ªäº›äº‹æƒ…å‘¢ï¼Ÿç†è®ºä¸Šæ¥è¯´ï¼Œå®ƒèƒ½åšè®¡ç®—æœºä¸­çš„ä»»ä½•äº‹æƒ…ã€‚å› æ­¤ï¼Œåœ¨Unsafe Rustä¸­ï¼Œä½ ä¹Ÿèƒ½åšè®¡ç®—æœºä¸­çš„ä»»ä½•äº‹æƒ…ã€‚Cçš„å¼ºå¤§å¨åŠ›æ¥æºäºå®ƒé”‹åˆ©çš„æŒ‡é’ˆï¼Œè€Œåœ¨Unsafe Rustä¸­ä¹Ÿæä¾›äº†è¿™ç§èƒ½åŠ›ã€‚

## è¢«å°å°çš„èƒ½åŠ›

Safe Rustç‹å›½æœ‰äº›æŠ€èƒ½è¢«å°å°äº†ï¼Œè€Œè¿™äº›æŠ€èƒ½è¿›å…¥åˆ°Unsafe Rustç‹å›½åï¼Œå°±å¯ä»¥è¢«æ­å¼€ä½¿ç”¨ã€‚å…·ä½“æ¥è¯´ï¼Œæœ‰5ç§æŠ€èƒ½ã€‚

1. è§£å¼•ç”¨åŸå§‹æŒ‡é’ˆ
2. è°ƒç”¨unsafeå‡½æ•°æˆ–æ–¹æ³•
3. è®¿é—®æˆ–ä¿®æ”¹å¯å˜çš„é™æ€å˜é‡
4. å®ç°ä¸€ä¸ªunsafe trait
5. è®¿é—® union ä¸­çš„å­—æ®µ

è¿™é‡Œæˆ‘ä»¬ç®€å•æä¸€ä¸‹è¿™5ä¸ªæ–¹é¢ï¼Œæˆ‘ä»¬ä»ç¬¬5ç‚¹è®²èµ·ã€‚unionæˆ‘ä»¬åœ¨è¯¾ç¨‹é‡Œæ²¡æœ‰è®²ï¼Œè¿™é‡Œæˆ‘ä»¬ç®€å•äº†è§£ä¸‹ã€‚å®ƒæ˜¯ä¸€ä¸ªç±»ä¼¼äºCä¸­unionçš„è®¾è®¡ï¼Œä¹Ÿå°±æ˜¯æ‰€æœ‰å­—æ®µå…±åŒå æœ‰åŒä¸€å—å­˜å‚¨ç©ºé—´ã€‚è®¿é—®å®ƒçš„å­—æ®µæ—¶ï¼Œéœ€è¦åœ¨ Unsafe Rust ä¸­ä½¿ç”¨ã€‚

```plain
union IntOrFloat {
    i: u32,
    f: f32,
}
let mut u = IntOrFloat { f: 1.0 };
// è¯»å–unionå­—æ®µæ—¶éœ€è¦ç”¨ unsafe {} åŒ…èµ·æ¥
assert_eq!(unsafe { u.i }, 1065353216);
// æ›´æ–°äº†iï¼Œç»“æœfå­—æ®µçš„å€¼ä¹Ÿå˜åŒ–äº†ã€‚
u.i = 1073741824;
assert_eq!(unsafe { u.f }, 2.0);

```

æˆ‘ä»¬ä¸€èˆ¬ç”¨ä¸åˆ° unionï¼Œå¦‚æœéœ€è¦æ·±å…¥ç ”ç©¶ï¼Œå¯ä»¥æŸ¥çœ‹æˆ‘ç»™å‡ºçš„ [é“¾æ¥](https://doc.rust-lang.org/std/keyword.union.html)ã€‚

ç¬¬4ç‚¹ï¼Œæˆ‘ä»¬å¯ä»¥ç»™ trait å®ç° unsafeï¼Œè¿™å—å†…å®¹æ¯”è¾ƒæ·±ï¼Œæ‰€ä»¥åœ¨æˆ‘ä»¬è¿™é—¨åˆçº§è¯¾ç¨‹é‡Œä¸è¦æ±‚äº†è§£ï¼Œå¦‚æœä½ æœ‰å…´è¶£å¯ä»¥æŸ¥çœ‹æˆ‘ç»™å‡ºçš„ [é“¾æ¥](https://doc.rust-lang.org/nomicon/safe-unsafe-meaning.html)ã€‚

ç¬¬3ç‚¹ä¹Ÿå°±æ˜¯å…¨å±€é™æ€å˜é‡ï¼Œå‰é¢æˆ‘ä¸æå€¡ä¿®æ”¹å®ƒï¼Œå› ä¸ºå®ƒæ˜¯ä¸€ç§ä¸å¤ªå¥½çš„ç¼–ç¨‹æ¨¡å‹ã€‚ä½†æ˜¯å¦‚æœä½ éè¦æ”¹çš„è¯ï¼Œä¹Ÿæ˜¯æœ‰åŠæ³•çš„ï¼Œé‚£å°±ç•™ä¸‹è¶³è¿¹ï¼ŒåŠ ä¸ª `unsafe {}` å¥—èµ·æ¥ï¼Œæ¯”å¦‚ the book é‡Œçš„ [ç¤ºä¾‹](https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#accessing-or-modifying-a-mutable-static-variable)ã€‚

```plain
// è¿™é‡Œä¿®é¥°ä¸º mut
static mut COUNTER: u32 = 0;
fn add_to_count(inc: u32) {
    // ä¿®æ”¹å…¨å±€å¯å˜é™æ€å˜é‡éœ€è¦ç”¨ unsafe
    unsafe {
        COUNTER += inc;
    }
}
fn main() {
    add_to_count(3);
    // è®¿é—®å…¨å±€å¯å˜é™æ€å˜é‡ä¹Ÿéœ€è¦ç”¨ unsafe
    unsafe {
        println!("COUNTER: {}", COUNTER);
    }
}
// è¾“å‡º
COUNTER: 3

```

ä¸‹é¢æˆ‘æ¥é‡ç‚¹è®²è§£ä¸€ä¸‹å‰2ç§åœºæ™¯ã€‚

### unsafeå…³é”®å­—

Rustä¸­æœ‰ä¸€ä¸ª unsafe å…³é”®å­—ï¼Œç”¨æ¥æ˜¾å¼åœ°æ ‡æ˜æˆ‘ä»¬è¦è¿›å…¥ unsafe Rust çš„é¢†åœ°ã€‚unsafe å…³é”®å­—å¯ä»¥ä¿®é¥° fnã€traitï¼Œè¿˜å¯ä»¥åœ¨åé¢è·Ÿä¸€ä¸ª {} è¡¨æ˜è¿™æ˜¯ä¸€ä¸ª unsafe å—ï¼ŒæŠŠå¯èƒ½ä¸å®‰å…¨çš„é€»è¾‘åŒ…èµ·æ¥ï¼Œåƒä¸‹é¢è¿™æ ·ï¼š

```plain
unsafe {
    //...
}

```

è¿™é‡Œï¼Œéœ€è¦è¯´æ˜ä¸€ä¸‹ï¼Œè¢« unsafe æ ‡è¯†æˆ–åŒ…èµ·æ¥çš„ä»£ç ï¼Œå¹¶ä¸æ˜¯è¯´ä¸€å®šæœ‰é—®é¢˜ã€‚å®ƒçš„å‡†ç¡®æ„æ€æ˜¯ï¼š **Rustcç¼–è¯‘å™¨ä¸ä¿è¯è¢«unsafeæ ‡è¯†çš„ä»£ç æ˜¯å®‰å…¨çš„ï¼Œä½ åº”è¯¥ä¿è¯ä½ å†™çš„ä»£ç æ˜¯å®‰å…¨çš„**ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œunsafe è¿™ä¸ªæ ‡è¯†ç¬¦ï¼Œåœ¨ä»£ç ä¸­ç•™ä¸‹äº†æ˜ç¡®çš„è¶³è¿¹ï¼Œå°†äº¤ç”±Rustcå…¨æƒä¿è¯å®‰å…¨çš„ä»£ç ï¼Œå’Œä¸äº¤ç”±Rustcå…¨æƒä¿è¯å®‰å…¨çš„ä»£ç ï¼Œåˆ†éš”å¼€äº†ã€‚

è¯·æ³¨æ„ä¸Šé¢è¿™å¥è¯çš„ç”¨è¯ï¼Œâ€œä¸äº¤ç”±Rustcå…¨æƒä¿è¯å®‰å…¨çš„ä»£ç éƒ¨åˆ†â€å¹¶ä¸æ˜¯è¯´Rustcç¼–è¯‘å™¨å°±å®Œå…¨ä¸æ£€æŸ¥ unsafe é‡Œçš„ä»£ç äº†ï¼Œå®é™…Rustcåªæ˜¯å¯¹ä¸Šé¢æåˆ°çš„5ç§æŠ€èƒ½ä¸åŠ æ£€æŸ¥ã€‚å¯¹äºSafe Rusté‡Œçš„å†…å®¹è¿˜æ˜¯è¦åšæ£€æŸ¥ï¼Œè·Ÿä¹‹å‰ä¸€æ ·ã€‚æˆ‘ä»¬æ¥çœ‹ä¸€ä¸ªç¤ºä¾‹ã€‚

```plain
fn main() {
Â  Â  let v = [1,2,3];

Â  Â  unsafe {
Â  Â  Â  Â  println!("COUNTER: {}", v[3]);
Â  Â  }
}
// ç¼–è¯‘è¾“å‡º
warning: unnecessary `unsafe` block
Â --> src/main.rs:4:5
Â  |
4 |Â  Â  Â unsafe {
Â  |Â  Â  Â ^^^^^^ unnecessary `unsafe` block
Â  |
Â  = note: `#[warn(unused_unsafe)]` on by default

error: this operation will panic at runtime
Â --> src/main.rs:5:33
Â  |
5 |Â  Â  Â  Â  Â println!("COUNTER: {}", v[3]);
Â  |Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â ^^^^ index out of bounds: the length is 3 but the index is 3

```

ç¤ºä¾‹ä¸­ï¼Œæˆ‘ä»¬éœ€è¦é‡ç‚¹å…³æ³¨ array çš„ä¸‹æ ‡ç´¢å¼•è¶Šç•Œçš„é—®é¢˜ã€‚æˆ‘ä»¬åœ¨ [ç¬¬ 1 è®²](https://time.geekbang.org/column/article/718865) é‡Œå·²ç»è®²è¿‡ï¼Œarrayçš„ä¸‹æ ‡ç´¢å¼•è¶Šç•Œä¼šåœ¨ç¼–è¯‘æœŸè¢«æ£€æŸ¥å‡ºæ¥ï¼Œå¯ä»¥çœ‹åˆ°ï¼Œå³ä½¿æ”¾åœ¨ unsafe block ä¸­ï¼Œå®ƒä»ç„¶æ‰§è¡Œäº†æ£€æŸ¥ã€‚è¿™å°è¯äº†æˆ‘ä»¬ä¸Šé¢çš„è¯´æ³•ï¼š **è¢« unsafe æ ‡è¯†çš„ä»£ç ï¼Œå¹¶ä¸æ˜¯è®©Rustcå®Œå…¨ä¸ç®¡ï¼Œè€Œåªæ˜¯æŸå‡ ç§æŠ€èƒ½è®©Rustcä¸ç®¡**ã€‚Safe Rustä¸­çš„é‚£äº›å…ƒç´ ï¼ŒRustcè¯¥ç®¡çš„è¿˜æ˜¯è¦ç®¡ã€‚

æ‰€ä»¥å³ä½¿æ˜¯Unsafe Rustï¼Œçœ‹ä¸Šå»ä¹Ÿè¦æ¯”å†™ C ä»£ç æ¥å¾—â€œå®‰å…¨â€ï¼ŒçŠ¯é”™çš„é£é™©æ›´å°ä¸€äº›ã€‚å¦å¤–ç¼–è¯‘å™¨æŒ‡å‡ºè¿™é‡Œ unsafe å—æ²¡ä»€ä¹ˆç”¨ï¼Œå¯ä»¥å»æ‰ï¼Œæˆ‘ä»¬ç¡®å®æ²¡ä½¿ç”¨å®ƒã€‚

### åŸå§‹æŒ‡é’ˆ

Rustä¸­æœ‰ä¸¤ç§åŸå§‹æŒ‡é’ˆï¼ˆraw pointerï¼‰ï¼Œ `*const T` å’Œ `*mut T`ã€‚ç”¨æ³•å¦‚ä¸‹ï¼š

```plain
fn main() {
Â  Â  let my_num: i32 = 10;
Â  Â  let my_num_ptr: *const i32 = &my_num;
Â  Â  let mut my_speed: i32 = 88;
Â  Â  let my_speed_ptr: *mut i32 = &mut my_speed;

Â  Â  unsafe {
Â  Â  Â  Â  println!("my_num is: {}", *my_num_ptr);
Â  Â  Â  Â  println!("my_speed is: {}", *my_speed_ptr);
Â  Â  }
}
// è¾“å‡º
my_num is: 10
my_speed is: 88

```

ä¹Ÿå°±æ˜¯å¯ä»¥å°†ä¸å¯å˜å¼•ç”¨ `&T` è½¬æ¢æˆ `*const T` æŒ‡é’ˆã€‚å°†å¯å˜å¼•ç”¨ `&mut T` è½¬æ¢æˆ `*mut T` æŒ‡é’ˆã€‚ä½ ä¹Ÿå¯ä»¥ç”¨ [as æ“ä½œç¬¦](https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#dereferencing-a-raw-pointer) æ¥è½¬æ¢ã€‚

ä¹‹å‰æˆ‘ä»¬è®²è¿‡ï¼Œå¼•ç”¨æ˜¯å¿…é¡»æœ‰æ•ˆçš„æŒ‡é’ˆï¼Œè€ŒæŒ‡é’ˆä¸ä¸€å®šæ˜¯å¼•ç”¨ï¼Œåœ¨è¿™é‡Œå°±å¾—åˆ°äº†å……åˆ†çš„ä½“ç°ã€‚åŸå§‹æŒ‡é’ˆæŒ‡å‘çš„æ•°æ®ä¸å¯¹çš„è¯ï¼Œè§£å¼•ç”¨æœ‰å¯èƒ½ä¼šå¯¼è‡´æ®µé”™è¯¯æˆ–å…¶ä»–æœªå®šä¹‰è¡Œä¸ºã€‚å› æ­¤å¼•ç”¨è½¬æ¢ä¸ºåŸå§‹æŒ‡é’ˆçš„æ—¶å€™ï¼Œä¸éœ€è¦åŒ…unsafeï¼Œè§£å¼•ç”¨åŸå§‹æŒ‡é’ˆçš„æ—¶å€™ï¼Œè¦ç”¨unsafeåŒ…èµ·æ¥ã€‚è¿™å°±æ˜¯æˆ‘ä»¬ä¸Šé¢è¯´çš„é‚£5ç§è¢«å°å°çš„èƒ½åŠ›ä¸­çš„ç¬¬ä¸€ç§èƒ½åŠ›ï¼š **åœ¨ unsafe Rust ä¸­ï¼Œå¯ä»¥è§£å¼•ç”¨åŸå§‹æŒ‡é’ˆã€‚**

ä¸€æ—¦æ¥è§¦åˆ°äº†åŸå§‹æŒ‡é’ˆï¼Œä¹Ÿå°±å¼€å¯äº†è®¡ç®—æœºåº•å±‚ç³»ç»Ÿçš„å¤§é—¨ã€‚ä½ å¯ä»¥çœ‹æˆ‘æ”¾åœ¨è¿™é‡Œçš„ä¸¤ä¸ªé“¾æ¥ï¼Œæ„Ÿå—ä¸€ä¸‹åŸå§‹æŒ‡é’ˆçš„å¤æ‚æ€§ã€‚

- [https://doc.rust-lang.org/std/primitive.pointer.html](https://doc.rust-lang.org/std/primitive.pointer.html)
- [https://doc.rust-lang.org/std/ptr/index.html](https://doc.rust-lang.org/std/ptr/index.html)

### `Box<T>` è½¬æˆåŸå§‹æŒ‡é’ˆ

`Box<T>` æ˜¯å¸¦æ‰€æœ‰æƒçš„æ™ºèƒ½æŒ‡é’ˆï¼Œå®ƒæœ‰ä¸€ä¸ª `into_raw()` å‡½æ•°å¯ä»¥è½¬æ¢æˆåŸå§‹æŒ‡é’ˆã€‚è¿™ä¸ªè½¬æ¢å¯¹äºå†…å­˜é‡Œçš„èµ„æºæ²¡æœ‰å½±å“ã€‚ä½†æ˜¯è¦å†ä»raw pointerè½¬å›Boxå°±è¦æ”¾åœ¨ unsafe é‡ŒåŒ…èµ·æ¥ï¼Œ `Box::from_raw()` æ˜¯ unsafe çš„ã€‚

```plain
fn main() {
Â  Â  let my_speed: Box<i32> = Box::new(88);
Â  Â  let my_speed: *mut i32 = Box::into_raw(my_speed);

Â  Â  unsafe {
Â  Â  Â  Â  let _ = Box::from_raw(my_speed);
Â  Â  }
}

```

è¿™å®é™…ä¸Šä¹Ÿæ˜¯å¯¹åŸå§‹æŒ‡é’ˆè§£å¼•ç”¨çš„ä¸€ä¸ªå˜å½¢ï¼Œæ‰€ä»¥è¦æ”¾åœ¨ unsafe å—é‡Œã€‚

### nullæŒ‡é’ˆ

ä¹‹å‰æˆ‘ä»¬è¯´è¿‡ï¼ŒRustä¸­ä¸å­˜åœ¨null/nilå€¼ï¼Œæ‰€æœ‰çš„å˜é‡éƒ½å¿…é¡»åˆå§‹åŒ–ã€‚è¿™åœ¨Safe Rusté‡Œæ˜¯æ­£ç¡®çš„ã€‚ä½†æ˜¯åœ¨Unsafe Rustä¸­ï¼Œå´æä¾›äº†nullæŒ‡é’ˆçš„è¡¨ç¤ºã€‚

å¯ä»¥ç”¨ std::ptr é‡Œçš„ `null()` å’Œ `null_mut()` ç”Ÿæˆä¸¤ç§åŸå§‹ç©ºæŒ‡é’ˆã€‚

```plain
fn main() {
Â  Â  use std::ptr;

Â  Â  let p: *const i32 = ptr::null();
Â  Â  assert!(p.is_null());
Â  Â  let p: *mut i32 = ptr::null_mut();
Â  Â  assert!(p.is_null());
}

```

Rustä¸­ä¸ºä»€ä¹ˆä¼šæœ‰ç©ºæŒ‡é’ˆå­˜åœ¨ï¼Ÿæœ‰ä»€ä¹ˆä½œç”¨å‘¢ï¼Ÿé‚£æ˜¯å› ä¸ºCè¯­è¨€ä¸­æœ‰ç©ºæŒ‡é’ˆè¿™ä¸ªä¸œè¥¿ã€‚ä¸ºäº†ä¸Cæ‰“äº¤é“ï¼ŒRustä¸­è¦æœ‰å¯¹åº”çš„è®¾è®¡ï¼Œå¥½ä¸Cåº“æˆ–è€…Cåº”ç”¨ç¨‹åºå¯¹æ¥ï¼Œæ¯•ç«Ÿåœ¨Rustå‡ºæ¥ä¹‹å‰ï¼ŒC/C++ å·²ç»å»ºæˆäº†è¿™ä¸ªè½¯ä»¶ä¸–ç•Œçš„åœ°åŸºã€‚

### Safeä¸Unsafeçš„è¾¹ç•Œ

åœ¨Rustä¸­ï¼Œunsafeå‡½æ•°å¿…é¡»åœ¨ unsafe å‡½æ•°ä¸­è°ƒç”¨ï¼Œæˆ–ä½¿ç”¨ `unsafe {}` å—åŒ…èµ·æ¥è°ƒç”¨ã€‚å› æ­¤ä¸‹é¢çš„ä»£ç æ˜¯å¯ä»¥çš„ï¼š

```plain
fn foo() {
Â  Â  let my_num_ptr = &10 as *const i32;
Â  Â  let my_speed_ptr = &mut 88 as *mut i32;

Â  Â  unsafe {
Â  Â  Â  Â  println!("my_num is: {}", *my_num_ptr);
Â  Â  Â  Â  println!("my_speed is: {}", *my_speed_ptr);
Â  Â  }
}

fn main() {
Â  Â  foo();
}

```

å¯ä»¥çœ‹åˆ°ï¼Œ `foo()` å‡½æ•°ä¸­åŒ…å«äº† unsafe å—çš„è°ƒç”¨ã€‚ä½†æ˜¯ä» `main()` å‡½æ•°çš„è§’åº¦æ¥çœ‹ï¼Œå®ƒè°ƒç”¨ `foo()` æ—¶ä¸éœ€è¦åœ¨å¤–é¢å†å¥—ä¸€å±‚ `unsafe {}` æ¥è°ƒç”¨äº†ã€‚è¿™é‡Œå®é™…ä½“ç°äº†é‡è¦çš„ä¸€ç‚¹ï¼Œ **Unsafe ä¸ Safe çš„è¾¹ç•Œ**ã€‚ç¤ºä¾‹ä»£ç é‡Œä¸¤è€…çš„è¾¹ç•Œå°±åœ¨ `foo()` å‡½æ•°ä¸­ã€‚

ä» `main()` çš„è§†è§’æ¥çœ‹ï¼Œå®ƒè°ƒç”¨çš„ `foo()` æœ‰å¯èƒ½æ˜¯ç¬¬ä¸‰æ–¹åº“æš´éœ²å‡ºæ¥çš„æ¥å£ï¼Œå¹¶ä¸çŸ¥é“é‡Œé¢å…·ä½“çš„å®ç°ï¼ŒåªçŸ¥é“è¿™ä¸ªå‡½æ•°å¯ä»¥æŒ‰Safe Rustçš„å½¢å¼å®‰å…¨è°ƒç”¨ã€‚è¿™é‡Œçš„è¿™ä¸ª `foo()` å°±æ˜¯ **å¯¹unsafeä»£ç çš„safeå°è£…**ã€‚

æˆ‘ä»¬å†æ¥çœ‹ä¸€ä¸ªå®é™…ä¸€ç‚¹çš„ä¾‹å­ã€‚

```plain
use std::slice;
fn split_at_mut(values: &mut [i32], mid: usize) -> (&mut [i32], &mut [i32]) {
    let len = values.len();
    let ptr = values.as_mut_ptr();
    assert!(mid <= len);
    unsafe {
        (
            slice::from_raw_parts_mut(ptr, mid),
            slice::from_raw_parts_mut(ptr.add(mid), len - mid),
        )
    }
}
fn main() {
    let mut vector = vec![1, 2, 3, 4, 5, 6];
    let (left, right) = split_at_mut(&mut vector, 3);
}

```

ä¸Šé¢å‡½æ•°å°†ä¸€ä¸ª i32 æ•°ç»„çš„ slice å¯å˜å¼•ç”¨åˆ†æˆäº†å‰åä¸¤æ®µsliceå¯å˜å¼•ç”¨ã€‚è¿™åœ¨ Safe Rust æ˜¯åšä¸åˆ°çš„ï¼Œå› ä¸ºåŒæ—¶å¯¹åŸæ•°ç»„å­˜åœ¨äº†ä¸¤ä¸ªå¯å˜å¼•ç”¨ï¼Œè¯¦æƒ…è¯·çœ‹ [å®˜æ–¹ä¹¦](https://doc.rust-lang.org/book/ch19-01-unsafe-rust.html#creating-a-safe-abstraction-over-unsafe-code)ã€‚

åœ¨Unsafe Rustä¸­å¯ä»¥åšåˆ°ï¼Œä½†æ˜¯ `slice::from_raw_parts_mut()` åªèƒ½ç”¨ `unsafe {}` åŒ…èµ·æ¥è°ƒç”¨ã€‚è€Œå¯¹ä¸šåŠ¡å¼€å‘è€…æ¥è¯´ï¼Œåœ¨ `main()` å‡½æ•°ä¸­ä»¥Safe Rustçš„å½¢å¼ç›´æ¥ä½¿ç”¨ `split_at_mut()` å°±è¡Œäº†ï¼Œä¸€åˆ‡å°±å¥½åƒ `split_at_mut()` æ˜¯çœŸæ­£safeçš„ä¸€æ ·ã€‚åœ¨è¿™é‡Œï¼Œå®ƒç¡®å®æ˜¯safeçš„ï¼Œåªä¸è¿‡è¿™ä¸ªsafeä¸æ˜¯ç”±Rustcæ¥ä¿è¯çš„safeï¼Œè€Œæ˜¯ç”±æˆ‘ä»¬ç¨‹åºå‘˜è‡ªå·±ä¿è¯çš„safeã€‚æˆ‘ä»¬çŸ¥é“æˆ‘ä»¬åœ¨å¹²ä»€ä¹ˆï¼Œä¸¤ä¸ª slice å¹¶ä¸é‡å ï¼Œä¸ä¼šæœ‰é—®é¢˜ã€‚

å¦‚æœæ‰“ç ´ç ‚é”…é—®åˆ°åº•çš„è¯ï¼Œæ˜¯ä¸æ˜¯å‡ ä¹æ‰€æœ‰çš„Ruståº•å±‚éƒ½æœ‰è¿™ä¸ªé—®é¢˜ï¼Ÿè·Ÿè¸ªåˆ°æœ€åº•å±‚ä»£ç çš„è¯ï¼Œæ˜¯ä¸æ˜¯éƒ½æ˜¯ unsafe çš„ï¼Ÿå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆRustæ‰€æ ‡æ¦œçš„ safeï¼Œå²‚ä¸æ˜¯ä¸€ä¸ªè™šå¹»çš„ç©ºä¸­æ¥¼é˜ï¼Ÿ

ä½ çš„çŒœæµ‹å¤§ä½“æ˜¯æ­£ç¡®çš„ã€‚

### æå°åŒ–Unsafeå±‚

ä»æœ¬è´¨æ¥è¯´ï¼Œä¸–ç•Œæ˜¯å»ºç«‹åœ¨unsafeä¸Šé¢çš„ã€‚

ä»ç¡¬ä»¶æ¥è¯´ï¼Œæˆ‘ä»¬ç¼–å†™ç¨‹åºæ¥æ“ä½œå„ç§è®¾å¤‡ï¼Œå†…å­˜ã€ç¡¬ç›˜ã€æ˜¾å¡ã€ç½‘ç»œè®¾å¤‡ç­‰ç­‰ï¼Œå¯¹å®ƒä»¬çš„æ“ä½œå®Œå…¨æœ‰å¯èƒ½æ˜¯ä¸å®‰å…¨çš„ï¼Œè¿™ä¸ªé”™è¯¯å¯èƒ½æ¥è‡ªå„ç§å±‚æ¬¡ï¼Œæ¯”å¦‚ç”µæºæ³¢åŠ¨å¼•èµ·çš„æ•…éšœã€çº¿è·¯è€åŒ–æ•…éšœã€æ™¶ä½“ç®¡æŸåæ•…éšœï¼Œç”šè‡³æ˜¯å¤ªé˜³é»‘å­çˆ†å‘å¼•èµ·çš„æ•…éšœç­‰ç­‰ã€‚

ä»è½¯ä»¶æŒ‡ä»¤æ¥è¯´ï¼Œå½“ä»£ç ç¼–è¯‘æˆäºŒè¿›åˆ¶åï¼Œè¿™ä¸ªäºŒè¿›åˆ¶å¯æ‰§è¡Œåºåˆ—çš„å¨åŠ›æ˜¯æ— ç©·å¤§çš„ï¼Œç†è®ºä¸Šå¯ä»¥å¯¹è®¡ç®—æœºå†…å­˜å’Œè®¾å¤‡åœ°å€åšä»»æ„è®¿é—®ï¼Œè¿™ä¹Ÿæ˜¯hackè¡Œä¸ºçš„æºå¤´ã€‚åªè¦hackeræ‰¾åˆ°äº†ä½ ç¨‹åºä¸­çš„æ¼æ´ï¼Œå®ƒå°±å¯èƒ½åœ¨ä½ çš„è®¡ç®—æœºä¸­åšä»»ä½•å±é™©çš„äº‹æƒ…ã€‚è¿™å°±æ˜¯Cè¿™ç§é æŒ‡é’ˆåƒé¥­çš„è¯­è¨€å¼ºå¤§ä¸”å±é™©çš„åŸå› ã€‚

ä¸ç®¡æ˜¯ä»ç¡¬ä»¶å±‚é¢è¿˜æ˜¯è½¯ä»¶å±‚é¢ï¼Œä½ çš„ä¸€ä¸ªæ“ä½œå®Œå…¨å¯èƒ½ä¼šå¾—åˆ°ä¸€ä¸ªæœªçŸ¥çš„è¡Œä¸ºæˆ–æœªå®šä¹‰è¡Œä¸º [Undefined Behaviour](https://doc.rust-lang.org/reference/behavior-considered-undefined.html)ã€‚ **ä»Safe Rustçš„è§‚ç‚¹æ¥çœ‹ï¼Œä¸€ä¸ªä¼šäº§ç”Ÿæœªå®šä¹‰è¡Œä¸ºçš„æ“ä½œï¼Œå°±æ˜¯Unsafeçš„**ã€‚è€Œunsafeçš„æ“ä½œï¼Œéƒ½å¿…é¡»æ˜ç¡®åœ°æ”¾åœ¨ `unsafe {}` å—ä¸­éš”ç¦»ã€‚

å› æ­¤ï¼Œåœ¨Safe Rustçœ‹æ¥ï¼Œå¨åŠ›è¿‡å¤§çš„æŠ€èƒ½ï¼Œæ¯”å¦‚åŸå§‹æŒ‡é’ˆçš„è§£å¼•ç”¨ï¼Œå¯èƒ½è®¿é—®åˆ°æœªåˆå§‹åŒ–çš„åœ°å€ï¼Œæˆ–è€…æ˜¯å·²ç»é‡Šæ”¾åçš„åœ°å€ï¼Œå› æ­¤å®ƒæ˜¯Unsafeçš„ï¼›å¤–éƒ¨çš„C/C++ä»£ç ï¼Œå®ƒä»¬éƒ½å¾—é ç¨‹åºå‘˜è‡ªå·±æ¥ä¿è¯å®‰å…¨æ€§ï¼Œå› æ­¤å®ƒä»¬æ˜¯ä¸å¯ä¿¡ä»»çš„ï¼ŒæŠŠå®ƒä»¬éƒ½å½’ç±»åˆ° Unsafe ä¸­ï¼›å¯¹å¤–éƒ¨è®¾å¤‡çš„æ“ä½œï¼Œå·²ç»è¶…è¿‡å†…å­˜èµ„æºçš„ç®¡ç†æƒé™äº†ï¼ŒRustè‡ªå·±é­é•¿è«åŠï¼Œå› æ­¤æŠŠå®ƒå½’ä¸ºä¸ä¿¡ä»»ï¼Œå½’ç±»åˆ° Unsafe ä¸­ã€‚

äºæ˜¯æˆ‘ä»¬å¯ä»¥çœ‹åˆ°ï¼ŒRustå°†æ‰€æœ‰ä»£ç åˆ†å‰²æˆäº† Safe çš„å’Œ Unsafeçš„ä¸¤å—ï¼Œä¸¤å—ä¹‹é—´å°±é€šè¿‡æ˜ç¡®çš„ `unsafe {}` æ ‡è¯†æ¥éš”ç¦»ï¼Œè¿™æ˜¯Rustçš„åŸºæœ¬ä¸–ç•Œè§‚ã€‚

åœ¨è¿™ä¸ªä¸–ç•Œè§‚ä¹‹ä¸Šï¼ŒåŸºäºRustçš„è½¯ä»¶ä½“ç³»è¿˜æœ‰ä¸€å¥—æŠ½è±¡å“²å­¦â€”â€”å½“éœ€è¦Unsafeæ—¶ï¼Œåº”è¯¥æŠŠå®ƒå°è£…åœ¨ä¸€ä¸ªæå°å±‚ï¼ˆminimalist layerï¼‰ï¼Œç„¶ååœ¨å®ƒçš„ä¸Šé¢å»ºç«‹ä¸Šå±‚å»ºç­‘ã€‚

ä¹Ÿå°±æ˜¯è¯´ï¼Œå¦‚æœä¸å¾—ä¸ç”¨Unsafeä»£ç ï¼Œé‚£è¯·å°è£…å°½é‡è–„çš„ä¸€å±‚unsafe layerï¼Œè€Œåœ¨å…¶ä¹‹ä¸Šå®Œå…¨ä½¿ç”¨safe rustç¼–å†™ã€‚è¿™ä¸ªæ—¶å€™å°±å¯ä»¥å›ç­”è¿™ä¸ªé—®é¢˜äº†ï¼šå¦‚æœæ˜¯ï¼Œé‚£ä¹ˆRustæ‰€æ ‡æ¦œçš„ safeï¼Œå²‚ä¸æ˜¯ä¸€ä¸ªè™šå¹»çš„ç©ºä¸­æ¥¼é˜ï¼Ÿ

Rusté€šè¿‡è¿™å¥—æ–¹æ³•å­¦ï¼Œè®©Safe Rustçš„ä»£ç éƒ¨åˆ†å¯ä»¥è‡ªè¯å®‰å…¨ï¼Œè€ŒUnsafe Rustçš„ä»£ç éƒ¨åˆ†ç”±ç¨‹åºå‘˜æ¥ä¿è¯å®‰å…¨ã€‚ä½ å¯ä»¥æƒ³è±¡ä¸€ä¸‹ï¼Œå¦‚æœä¸€ä¸ªç³»ç»Ÿæœ‰10ä¸‡è¡ŒRustä»£ç ï¼Œ98%çš„ä»£ç æ˜¯ Safe Rustï¼Œ2%çš„ä»£ç æ˜¯ Unsafe Rustï¼Œé‚£ä¹ˆéœ€è¦ç”±äººæ¥å®¡è®¡çš„ä»£ç å°±åªæœ‰2åƒè¡Œã€‚é‚£æˆ‘ä»¬å°±å¯ä»¥æŠŠæ‰€æœ‰ç²¾åŠ›é›†ä¸­åœ¨è¿™2åƒè¡Œä»£ç çš„å®¡è®¡ä¸Šï¼Œç¡®ä¿å®ƒä»¬ä¸ä¼šå‡ºé—®é¢˜ã€‚æˆ–è€…è¯´å³ä½¿å‡ºäº†é—®é¢˜ï¼Œä¹Ÿå¯ä»¥å»è¿™2åƒè¡Œä»£ç ä¸­å»æ‰¾åŸå› ã€‚

è€Œå¦‚æœåŒæ ·çš„è¿™å¥—ç³»ç»Ÿï¼Œç”±10ä¸‡è¡ŒC/C++ä»£ç æ¥å®ç°ï¼Œé‚£ä¹ˆå®¡è®¡çš„æ—¶å€™ï¼Œå°±å¿…é¡»å®¡è®¡ 10ä¸‡è¡Œä»£ç ï¼Œä¹Ÿå°±æ˜¯ 50 å€çš„å®¡è®¡å·¥ä½œé‡ã€‚é‡åˆ°é—®é¢˜ï¼Œä¹Ÿæ˜¯åœ¨10ä¸‡è¡Œä»£ç é‡Œé¢å»æ‰¾åŸå› ã€‚è¿™ä¸ªæˆæœ¬å®Œå…¨ä¸å¯æ¯”æ‹Ÿã€‚

å› æ­¤ï¼ŒRust æ‰€æ ‡æ¦œçš„ safeï¼Œå®Œå…¨ä¸æ˜¯ç©ºä¸­æ¥¼é˜ã€‚ä¸ä»…ä¸æ˜¯ç©ºä¸­æ¥¼é˜ï¼Œè¿˜æ˜¯éå¸¸åˆ‡å®å¯è¡Œçš„ä¸€å¥—è½¯ä»¶å·¥ç¨‹æ–¹æ³•å­¦ã€‚

## æ ‡å‡†åº“ä¸­çš„unsafeç¤ºä¾‹

Rustæ ‡å‡†åº“ä¸­æœ‰ä¸€äº›unsafeå‡½æ•°ï¼Œæˆ‘ä»¬æ¥çœ‹ä¸¤ä¸ªã€‚

### Sliceçš„ [get\_unchecked()](https://doc.rust-lang.org/std/primitive.slice.html\#method.get_unchecked) å‡½æ•°

```plain
fn main() {
Â  Â  let x = &[1, 2, 4];

Â  Â  unsafe {
Â  Â  Â  Â  assert_eq!(x.get_unchecked(1), &2);
Â  Â  }
}

```

åœ¨æœ‰ `get()` çš„æƒ…å†µä¸‹ï¼ŒRustæ ‡å‡†åº“è¿˜æä¾›è¿™ä¸ª `get_unchecked()` å‡½æ•°ï¼ŒåŸå› å…¶å®ä¹Ÿå¾ˆç®€å•ï¼Œå› ä¸º `get()` ä¼šè¿›è¡Œè¾¹ç•Œæ£€æŸ¥ï¼Œè€Œ `get_unchecked()` ä¸ä¼šã€‚åœ¨æœ‰äº›å¯†é›†è¿ç®—çš„æƒ…å†µä¸‹ï¼Œè¾¹ç•Œæ£€æŸ¥å¯¹æ€§èƒ½å½±å“æ¯”è¾ƒå¤§ï¼Œå› æ­¤æä¾›ä¸€ä¸ªä¸åšè¾¹ç•Œæ£€æŸ¥çš„ç‰ˆæœ¬ï¼Œç”¨æ¥è¿½æ±‚æè‡´çš„é€Ÿåº¦ã€‚æ¯•ç«Ÿï¼ŒRustæ˜¯ä¸€é—¨ä¸C/C++åœ¨åŒä¸€å±‚æ¬¡çš„è¯­è¨€ï¼Œä¸åº”è¯¥ç»™Rustäººä¸ºå‘†æ¿åœ°è®¾ç½®éšœç¢ï¼Œæ¯”å¦‚å¿…é¡»ä½¿ç”¨è¾¹ç•Œæ£€æŸ¥çš„å®‰å…¨ç‰ˆæœ¬ã€‚

### strçš„ [from\_utf8\_unchecked()](https://doc.rust-lang.org/std/str/fn.from_utf8_unchecked.html) å‡½æ•°

```plain
fn main() {
Â  Â  use std::str;

Â  Â  // some bytes, in a vector
Â  Â  let sparkle_heart = vec![240, 159, 146, 150];

Â  Â  let sparkle_heart = unsafe { str::from_utf8_unchecked(&sparkle_heart) };

Â  Â  assert_eq!("ğŸ’–", sparkle_heart);
}

```

è¿™ä¸ªå‡½æ•°æˆ‘ä»¬åœ¨ [ç¬¬ 4 è®²](https://time.geekbang.org/column/article/720426) èŠå­—ç¬¦ä¸²çš„æ—¶å€™æåˆ°è¿‡ï¼Œå®ƒä¸æ£€æŸ¥å­—èŠ‚åºåˆ—ä¸ºæœ‰æ•ˆçš„UTF8ç¼–ç ï¼Œå› æ­¤è½¬å‡ºæ¥å¯èƒ½ä¸æ˜¯æœ‰æ•ˆçš„å­—ç¬¦ä¸²ã€‚åŸå› ä¹Ÿå¾ˆç®€å•ï¼Œè¿˜æ˜¯ä¸ºäº†æ€§èƒ½ã€‚åœ¨æœ‰äº›åœºåˆä¸‹ï¼Œç»å¯¹çš„æ€§èƒ½å°±æ˜¯ç»å¯¹çš„ç‹é“ï¼ŒRustä¸ç»™ä½ è®¾ç½®å¤©èŠ±æ¿ã€‚

## å¤–éƒ¨å‡½æ•°æ¥å£ FFI

è¿™é‡Œæˆ‘æå‡ºä¸€ä¸ªé—®é¢˜ï¼Œä½ æ¥æƒ³ä¸€ä¸‹ã€‚ **ä¸€é—¨ç¼–ç¨‹è¯­è¨€å¦‚ä½•ä¸å¦ä¸€é—¨ç¼–ç¨‹è¯­è¨€åœ¨è¯­è¨€å±‚é¢äº¤äº’å‘¢ï¼Ÿ** è¿™ä¸ªé—®é¢˜è¿˜çœŸä¸å¥½åŠã€‚

äº‹å®ä¸Šï¼ŒåƒJavaScriptå°±ä¸å¤ªå¯èƒ½ç›´æ¥ä¸Pythonè¿›è¡Œäº¤äº’ã€‚å¤§éƒ¨åˆ†è¯­è¨€ä¹‹é—´æ˜¯æ²¡åŠæ³•ç›´æ¥äº¤äº’çš„ã€‚ä½†æ˜¯ï¼Œå†å²å´ç•™ä¸‹ä¸€ä¸ªæœ‰è¶£ä¸”å¯è´µçš„é—äº§â€”â€”æ‰€æœ‰ä¸»æµè¯­è¨€åŸºæœ¬éƒ½èƒ½ä¸Cè¯­è¨€äº¤äº’ï¼Œå› ä¸ºå®ƒä»¬éƒ½éœ€è¦ç”¨Cæ¥å†™æ‰©å±•ï¼Œæå‡æ€§èƒ½ã€‚å½“ç„¶ C++ æ˜¯åœ¨è¯­è¨€å±‚é¢ç›´æ¥åŒ…å«äº† Cï¼Œè¿™ä¸ªå¦å½“åˆ«è®ºã€‚

Ruståœ¨è®¾è®¡ä¹‹åˆï¼Œ **ä¸Cå®ç°äºŒè¿›åˆ¶çº§çš„å…¼å®¹** å°±æ˜¯ä¸€é¡¹é‡è¦ç›®æ ‡ã€‚äºŒè¿›åˆ¶å…¼å®¹çš„æ„æ€å…¶å®å°±æ˜¯Rustå¯ä»¥é€‰æ‹©ç¼–è¯‘ç›®æ ‡ä¸ºç¬¦åˆCè¯­è¨€ [ABI](https://en.wikipedia.org/wiki/Application_binary_interface)ï¼ˆApplication Binary Interfaceï¼‰çš„äºŒè¿›åˆ¶æ ¼å¼ã€‚

ABIåŒ…å«æ•°æ®ç»“æ„æ€ä¹ˆå¯¹é½ã€å­˜å‚¨ï¼Œå‡½æ•°å¦‚ä½•ä¼ å‚ã€è¿”å‚ã€è°ƒç”¨äºŒè¿›åˆ¶æ ¼å¼ä¿¡æ¯ç­‰ï¼Œè€ŒRustå°±æ”¯æŒç¼–è¯‘åˆ°éµå¾ª C ABI çš„äºŒè¿›åˆ¶åº“ç›®æ ‡ä¸Šã€‚è¿™æ„å‘³ç€ç”¨Rustç¼–å†™çš„å…±äº«åŠ¨æ€åº“ `.so`ã€ `.dll` ç­‰åœ¨å¤–ç•Œçœ‹æ¥ï¼Œä¸ç”¨Cç¼–è¯‘æˆçš„ `.so`ã€ `.dll` åŠ¨æ€åº“æ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œä½ ç”šè‡³ä¸çŸ¥é“æ˜¯ä»€ä¹ˆè¯­è¨€å†™æˆçš„ã€‚å› æ­¤ï¼ŒRustç¼–å†™çš„åŠ¨æ€åº“ä¹Ÿèƒ½è¢« Pythonã€JavaScriptã€Goã€Java ç­‰å…¶ä»–è¯­è¨€è°ƒç”¨ï¼Œå®ƒä»¬éƒ½æ”¯æŒC ABIåŠ¨æ€åº“ã€‚

å¦ä¸€æ–¹é¢ï¼Œ **Cå®ç°çš„åŠ¨æ€åº“ä¹Ÿèƒ½è¢«Rustæ— ç¼è°ƒç”¨**ï¼Œå› ä¸ºRustèƒ½è¯†åˆ«C ABIã€‚ä¸€ä¸ªCçš„åº“å‡½æ•°ï¼Œåœ¨Cåº”ç”¨ä¸­è¿è¡Œå’Œåœ¨Ruståº”ç”¨ä¸­è¿è¡Œæ²¡ä»€ä¹ˆåŒºåˆ«ï¼Œæ€§èƒ½ä¹Ÿæ²¡æœ‰æŸå¤±ï¼Œå°±å¥½åƒæ²¡æœ‰è·¨è¯­è¨€ä¸€æ ·ï¼Œè¿™å°±æ˜¯Rustçš„é­”æ³•æ‰€åœ¨ã€‚

è¿™ç‚¹ä¸å…¶ä»–åŠ¨æ€è¯­è¨€å¦‚ Pythonã€JavaScript ç­‰å°±æœ‰å¾ˆå¤§å·®åˆ«ã€‚è¿™äº›åŠ¨æ€è¯­è¨€åˆ°Cè¯­è¨€çš„FFIè¾¹ç•Œä¼šæœ‰ä¸å°çš„é¢å¤–æ¶ˆè€—ã€‚ç©¶å…¶åŸå› ï¼Œå°±æ˜¯å› ä¸ºå…¥å‚ä¸è¿”å‚ä¼šæœ‰ç±»å‹è½¬æ¢çš„å·¥ä½œï¼Œè€Œåœ¨è¿™äº›åŠ¨æ€è¯­è¨€ä¸­ï¼Œç±»å‹æ˜¯è¢«GCæ‰˜ç®¡çš„ï¼Œè¿™é‡Œé¢å°±æœ‰å¾ˆå¤šç»†èŠ‚è¦å¤„ç†ï¼Œä¼šå¸¦æ¥é¢å¤–çš„æ¶ˆè€—ã€‚è€ŒRustå°±ä¸å­˜åœ¨è¿™ä¸ªé—®é¢˜ï¼Œå‰é¢æˆ‘ä»¬æç¤ºï¼ŒUnsafe Rusté‡Œé¢ä½ç€ä¸€ä½Cå›½ç‹ï¼Œå°±å¥½åƒä¸€å®¶äººä¸€æ ·ï¼Œæˆ–è€…è‡³å°‘æ˜¯å…³ç³»å¾ˆè¿‘çš„äº²æˆšã€‚

å°½ç®¡å¦‚æ­¤ï¼Œæœ‰å…³Rustä¸Cçš„FFIçš„çŸ¥è¯†ç‚¹è¿˜æ˜¯éå¸¸å¤šçš„ï¼Œæœ‰è®¸å¤šè¦æ³¨æ„çš„åœ°æ–¹ï¼Œä¹Ÿä¸æ˜¯ä¸€ä¸‹å­å°±èƒ½æŒæ¡çš„ï¼Œéœ€è¦åœ¨å®é™…éœ€æ±‚äº§ç”Ÿæ—¶æŠ å„ç§ç»†èŠ‚ã€‚å¦å¤–ï¼ŒRustä¸­çš„Unsafeå…¶å®è¦æ±‚ä½ è€ƒè™‘æ›´å¤šï¼Œå› ä¸ºå®ƒæ¯”ä¼ ç»Ÿçš„Cè¯­è¨€å·¥ç¨‹æ›´è¯¦å°½åœ°è€ƒè™‘äº† [æœªå®šä¹‰è¡Œä¸º](https://doc.rust-lang.org/reference/behavior-considered-undefined.html) çš„æ¦‚å¿µï¼Œå®ƒè¦æ±‚ä½ å°½å¯èƒ½åœ°è€ƒè™‘å‘¨å…¨ï¼Œ **å› ä¸ºå°è£…ç»™Safe Rustçš„åŠŸèƒ½è¢«è¦æ±‚ä¸èƒ½äº§ç”Ÿä»»ä½•æœªå®šä¹‰è¡Œä¸º**ã€‚æ‰€ä»¥Rustä¸ä»…æ˜¯å·¥ç¨‹ä¸Šçš„åˆ›æ–°ï¼Œåœ¨å­¦æœ¯ç†è®ºä¸Šä¹Ÿæœ‰ä¸€å®šç¨‹åº¦çš„åˆ›æ–°ï¼Œç›®æ ‡å°±æ˜¯å†™å‡ºæ›´å¥å£®çš„ä»£ç ã€‚

## å°ç»“

![](images/739345/4fd442ed26a7f5d05bdb32c9eca7f703.jpg)

è¿™èŠ‚è¯¾æˆ‘ä»¬äº†è§£äº†æœ‰å…³Rustä¸­Unsafeå’ŒFFIçš„åŸºç¡€æ¦‚å¿µã€‚æˆ‘ä»¬è¿›å…¥Unsafe Ruståï¼Œå°±å¯ä»¥ä½¿ç”¨ä¸€äº›å¿…æ€æŠ€èƒ½äº†ã€‚è¿™äº›æŠ€èƒ½å¨åŠ›å·¨å¤§ï¼Œä½†æ˜¯ä¹Ÿå……æ»¡é£é™©ï¼Œéœ€è¦ç”±ç¨‹åºå‘˜è‡ªå·±æ¥ä¿è¯ä½¿ç”¨ä¸Šçš„å®‰å…¨æ€§ã€‚

æˆ‘ä»¬è¯´Rustç”±ä¸‰ä¸ªç‹å›½ç»„æˆï¼Œæ—¢ç„¶æ˜¯ç‹å›½ï¼Œé‚£ä¹ˆå†…å®¹é“å®šä¸ä¼šå°‘ã€‚ä» `unsafe {}` è¿™ä¸ªå¤§é—¨è¿›å…¥Unsafe Rustï¼Œå®é™…å°±è¿›å…¥äº†è®¡ç®—æœºä½“ç³»ç»“æ„çš„åº•å±‚ï¼Œä½ ä¼šå‘ç°ä¸€ç‰‡ç¾ä¸½æ–°ä¸–ç•Œã€‚è¿™ä¸ªä¸–ç•Œä¸­æœ‰ OSã€å†…å­˜ç»“æ„ã€å¯¹é½ã€é”ã€ABIã€è°ƒåº¦ã€æŒ‡ä»¤é›†ã€æ€»çº¿åè®®ç­‰ç­‰çœ¼èŠ±ç¼­ä¹±çš„æ–°ä¸œè¥¿ã€‚æˆ‘ä»¬ä¹‹å‰æåˆ°è¿‡ä¸€ç§è§‚ç‚¹ï¼Œ **å­¦ä¹ Rustå°±æ˜¯å­¦ä¹ CSè®¡ç®—æœºç§‘å­¦ï¼ŒUnsafe Rustå°±æ˜¯ä¸‹æ²‰ä¹‹é—¨**ã€‚

Rustä¸Cæœ‰æ­£ç»Ÿçš„è¡€è„‰å…³ç³»ï¼Œå¯ä»¥å®ç°çœŸæ­£çš„åŒå‘äº’é€šï¼Œè€Œæ²¡æœ‰è¾¹ç•Œæ€§èƒ½æŸå¤±ã€‚è¿™é¢„ç¤ºç€æœªæ¥åœ¨åµŒå…¥å¼ã€å·¥ä¸šæ§åˆ¶ã€èˆªç©ºèˆªå¤©ã€è‡ªåŠ¨é©¾é©¶ç­‰é¢†åŸŸï¼ŒRustéƒ½æœ‰éå¸¸å¤§çš„æ½œåŠ›æˆä¸ºä¸»æµé€‰æ‰‹ã€‚ç»å¤§éƒ¨åˆ†çš„äººå†™ç†Ÿäº†Rustä»¥åå°±å†ä¹Ÿä¸æƒ³å†™Cäº†ï¼Œç¼–ç¨‹ä½“éªŒå®Œå…¨ä¸å¯åŒæ—¥è€Œè¯­ã€‚é•¿æœŸæ¥çœ‹ï¼ŒCè¯­è¨€çš„ä»½é¢ä¼šé€æ¸ç¼“æ…¢åœ°èç¼©åˆ°ä¸€ä¸ªæ¯”è¾ƒå°çš„èŒƒå›´ï¼Œè€ŒRuståˆ™ä¼šæ‹…å½“èµ·Cè¯­è¨€ä¹‹å‰çš„é‡ä»»ã€‚

æˆ‘ä»¬è¦ç†è§£Rustå°†Safeå»ºç«‹åœ¨Unsafeçš„è¿™å¥—æ–¹æ³•ä¹‹ä¸Šï¼Œè¿™ä¹Ÿæ˜¯è½¯ä»¶å·¥ä¸šç•Œå‡ åå¹´æ¢ç´¢çš„ä¸€ä¸ªé‡è¦æˆæœã€‚æ‰€ä»¥ä½ ä¼šå¬åˆ°NASAã€å¾®è½¯ç­‰æœºæ„å‘¼åæ–°çš„è½¯ä»¶å¼€å‘ä¸è¦å†ä½¿ç”¨C/C++äº†ï¼Œè€Œåº”è¯¥ç”¨â€œå®‰å…¨ç¼–ç¨‹â€çš„è¯­è¨€æ¥å–ä»£ã€‚ä»è¿™ä¸ªæ„ä¹‰ä¸Šæ¥è®²ï¼ŒRustæ˜¯åˆ’æ—¶ä»£çš„è¯­è¨€ã€‚ä»¥åçš„è¯­è¨€å¯èƒ½ä¼šè¿™ä¹ˆåˆ†ç±»ï¼šRustä¹‹åçš„è¯­è¨€ä¸Rustä¹‹å‰çš„è¯­è¨€ã€‚

ä¸‹èŠ‚è¯¾æˆ‘ä»¬ä¼šå°†Rustä»£ç å¯¼å‡ºç»™Cè¯­è¨€ä½¿ç”¨ï¼Œå¹¶ä¸”è¿›ä¸€æ­¥å¯¼å‡ºç»™Pythonä½¿ç”¨ï¼Œç»™Pythonå®ç°ä¸€ä¸ªè‡ªå®šä¹‰æ‰©å±•ã€‚

## æ€è€ƒé¢˜

Unsafe Rustæ¯”Cè¯­è¨€æ›´å®‰å…¨å—ï¼Œä¸ºä»€ä¹ˆï¼Ÿæ¬¢è¿ä½ æŠŠè‡ªå·±çš„æ€è€ƒåˆ†äº«åˆ°è¯„è®ºåŒºï¼Œä¹Ÿæ¬¢è¿ä½ æŠŠè¿™èŠ‚è¯¾çš„å†…å®¹åˆ†äº«ç»™éœ€è¦çš„æœ‹å‹ï¼Œæˆ‘ä»¬ä¸‹èŠ‚è¯¾å†è§ï¼