# 15-è¯­æ³•é™çº§ä¸Polyfillï¼šè”åˆå‰ç«¯ç¼–è¯‘å·¥å…·é“¾ï¼Œæ¶ˆç­ä½ç‰ˆæœ¬æµè§ˆå™¨å…¼å®¹é—®é¢˜

è°ˆåˆ° Viteï¼Œå¯èƒ½å¾ˆå¤šäººéƒ½è§‰å¾—è¿™æ˜¯ä¸€ä¸ªç°ä»£å‰ç«¯æ„å»ºå·¥å…·ï¼Œåº”è¯¥åœ¨ç°ä»£æµè§ˆå™¨ä¸­ä½¿ç”¨ï¼Œæ”¾åˆ°å„ç§è¯­æ³•ç‰¹æ€§éƒ½ç¼ºå¤±çš„ä½ç‰ˆæœ¬æµè§ˆå™¨(å¦‚ `ie 11`)å°±ä¸é€‚ç”¨äº†ã€‚è¿™ç§è§‚å¿µå¯¹ä¸å¯¹å‘¢ï¼Ÿé¦–å…ˆè·Ÿå¤§å®¶æŠ›å‡ºç»“è®º: 

é€šè¿‡ Vite æ„å»ºæˆ‘ä»¬å®Œå…¨å¯ä»¥å…¼å®¹å„ç§ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œæ‰“åŒ…å‡ºæ—¢æ”¯æŒç°ä»£(`Modern`)æµè§ˆå™¨åˆæ”¯æŒæ—§ç‰ˆ(`Legacy`)æµè§ˆå™¨çš„äº§ç‰©ã€‚

æ¥ä¸‹é‡Œçš„è¯¾ç¨‹ä¸­ï¼Œæˆ‘å°±æ¥ä¸ä½ åˆ†æä¸€ä¸‹ä¸ºä»€ä¹ˆåœ¨ Vite ä¸­èƒ½å¤Ÿå½»åº•è§£å†³ä½ç‰ˆæœ¬æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ï¼Œä»¥åŠé€šè¿‡ä»€ä¹ˆæ‰‹æ®µè§£å†³ï¼Œéœ€è¦å€ŸåŠ©å“ªäº› JS çš„å·¥å…·å’Œç”Ÿæ€ã€‚ä½ ä¼šé¢†ç•¥åˆ°è¯¸å¤šå‰ç«¯ç¼–è¯‘å·¥å…·é“¾åº•å±‚çš„é£å…‰ï¼Œæ¯”å¦‚`@babel/preset-env`ã€`core-js`ã€`regenerator-runtime`ç­‰ç­‰å·¥å…·å’ŒåŸºç¡€åº“æ˜¯å¦‚ä½•å¼ºå¼ºè”åˆçš„ï¼Œå½“ç„¶ï¼Œæˆ‘ä¹Ÿä¼šä»¥å®˜æ–¹çš„ Vite æ’ä»¶`@vitejs/plugin-legacy`ä¸ºä¾‹å‘Šè¯‰ä½ å¦‚ä½•å°†è¿™äº›åº•å±‚çš„å·¥å…·é“¾æ¥å…¥åˆ° Vite ä¸­ï¼Œå¹¶å®ç°å¼€ç®±å³ç”¨çš„è§£å†³æ–¹æ¡ˆã€‚

## 1. åœºæ™¯å¤ç°

é¦–å…ˆæˆ‘ä»¬æ¥å¤ç°ä¸€ä¸‹é—®é¢˜åœºæ™¯ï¼Œä¸‹é¢ä¸¤å¼ å›¾ä»£è¡¨äº†ä¹‹å‰æˆ‘åœ¨çº¿ä¸Šç¯å¢ƒçœŸå®é‡åˆ°çš„æŠ¥é”™æ¡ˆä¾‹:

![img](./assets/1745592662770-1d3160a6-2ffd-4753-9823-b95b45855e07.png)

![img](./assets/1745592661945-97573c58-8b32-40b5-b5e9-b80651512ebc.png)

æŸäº›ä½ç‰ˆæœ¬æµè§ˆå™¨å¹¶æ²¡æœ‰æä¾› `Promise` è¯­æ³•ç¯å¢ƒä»¥åŠå¯¹è±¡å’Œæ•°ç»„çš„å„ç§ APIï¼Œç”šè‡³ä¸æ”¯æŒç®­å¤´å‡½æ•°è¯­æ³•ï¼Œä»£ç ç›´æ¥æŠ¥é”™ï¼Œä»è€Œå¯¼è‡´çº¿ä¸Šç™½å±äº‹æ•…çš„å‘ç”Ÿï¼Œå°¤å…¶æ˜¯éœ€è¦å…¼å®¹åˆ°`IE 11`ã€`iOS 9`ä»¥åŠ`Android 4.4`çš„åœºæ™¯ä¸­å¾ˆå®¹æ˜“ä¼šé‡åˆ°ã€‚

æ—§ç‰ˆæµè§ˆå™¨çš„è¯­æ³•å…¼å®¹é—®é¢˜ä¸»è¦åˆ†ä¸¤ç±»: **è¯­æ³•é™çº§é—®é¢˜**å’Œ **Polyfill ç¼ºå¤±é—®é¢˜**ã€‚å‰è€…æ¯”è¾ƒå¥½ç†è§£ï¼Œæ¯”å¦‚æŸäº›æµè§ˆå™¨ä¸æ”¯æŒç®­å¤´å‡½æ•°ï¼Œæˆ‘ä»¬å°±éœ€è¦å°†å…¶è½¬æ¢ä¸º`function(){}`è¯­æ³•ï¼›è€Œå¯¹åè€…æ¥è¯´ï¼Œ`Polyfill`æœ¬èº«å¯ä»¥ç¿»è¯‘ä¸º`å«ç‰‡`ï¼Œä¹Ÿå°±æ˜¯ä¸ºæµè§ˆå™¨æå‰æ³¨å…¥ä¸€äº› API çš„å®ç°ä»£ç ï¼Œå¦‚`Object.entries`æ–¹æ³•çš„å®ç°ï¼Œè¿™æ ·å¯ä»¥ä¿è¯äº§ç‰©å¯ä»¥æ­£å¸¸ä½¿ç”¨è¿™äº› APIï¼Œé˜²æ­¢æŠ¥é”™ã€‚

è¿™ä¸¤ç±»é—®é¢˜æœ¬è´¨ä¸Šæ˜¯é€šè¿‡å‰ç«¯çš„ç¼–è¯‘å·¥å…·é“¾(å¦‚`Babel`)åŠ JS çš„åŸºç¡€ Polyfill åº“(å¦‚`corejs`)æ¥è§£å†³çš„ï¼Œä¸ä¼šè·Ÿå…·ä½“çš„æ„å»ºå·¥å…·æ‰€ç»‘å®šã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œå¯¹äºè¿™äº›æœ¬è´¨çš„è§£å†³æ–¹æ¡ˆï¼Œåœ¨å…¶å®ƒçš„æ„å»ºå·¥å…·(å¦‚ Webpack)èƒ½ä½¿ç”¨ï¼Œåœ¨ Vite å½“ä¸­ä¹Ÿå®Œå…¨å¯ä»¥ä½¿ç”¨ã€‚

æ„å»ºå·¥å…·è€ƒè™‘çš„ä»…ä»…æ˜¯å¦‚ä½•å°†è¿™äº›åº•å±‚åŸºç¡€è®¾æ–½æ¥å…¥åˆ°æ„å»ºè¿‡ç¨‹çš„é—®é¢˜ï¼Œè‡ªå·±å¹¶ä¸éœ€è¦æä¾›åº•å±‚çš„è§£å†³æ–¹æ¡ˆï¼Œæ­£æ‰€è°“`æœ¯ä¸šæœ‰ä¸“æ”»`ï¼ŒæŠŠä¸“ä¸šçš„äº‹æƒ…äº¤ç»™ä¸“ä¸šçš„å·¥å…·å»åšã€‚æ¥ä¸‹æ¥çš„éƒ¨åˆ†ï¼Œæˆ‘å°±æ¥å¸¦ä½ ç†Ÿæ‚‰ä¸€ä¸‹æ‰€è°“`ä¸“ä¸šçš„å·¥å…·`åˆ°åº•æœ‰å“ªäº›ï¼Œä»¥åŠå¦‚ä½•ä½¿ç”¨è¿™äº›å·¥å…·ã€‚

## 2. åº•å±‚å·¥å…·é“¾

### 2.1. å·¥å…·æ¦‚è§ˆ

è§£å†³ä¸Šè¿°æåˆ°çš„ä¸¤ç±»è¯­æ³•å…¼å®¹é—®é¢˜ï¼Œä¸»è¦éœ€è¦ç”¨åˆ°ä¸¤æ–¹é¢çš„å·¥å…·ï¼Œåˆ†åˆ«åŒ…æ‹¬:

- **ç¼–è¯‘æ—¶å·¥å…·**ã€‚ä»£è¡¨å·¥å…·æœ‰`@babel/preset-env`å’Œ`@babel/plugin-transform-runtime`ã€‚
- **è¿è¡Œæ—¶åŸºç¡€åº“**ã€‚ä»£è¡¨åº“åŒ…æ‹¬`core-js`å’Œ`regenerator-runtime`ã€‚

**ç¼–è¯‘æ—¶å·¥å…·**çš„ä½œç”¨æ˜¯åœ¨ä»£ç ç¼–è¯‘é˜¶æ®µè¿›è¡Œ**è¯­æ³•é™çº§**åŠ**æ·»åŠ ** `**polyfill**` **ä»£ç çš„å¼•ç”¨è¯­å¥**ï¼Œå¦‚:

import "core-js/modules/es6.set.js"

ç”±äºè¿™äº›å·¥å…·åªæ˜¯ç¼–è¯‘é˜¶æ®µç”¨åˆ°ï¼Œè¿è¡Œæ—¶å¹¶ä¸éœ€è¦ï¼Œæˆ‘ä»¬éœ€è¦å°†å…¶æ”¾å…¥`package.json`ä¸­çš„`devDependencies`ä¸­ã€‚

è€Œ**è¿è¡Œæ—¶åŸºç¡€åº“**æ˜¯æ ¹æ® `ESMAScript`å®˜æ–¹è¯­è¨€è§„èŒƒæä¾›å„ç§`Polyfill`å®ç°ä»£ç ï¼Œä¸»è¦åŒ…æ‹¬`core-js`å’Œ`regenerator-runtime`ä¸¤ä¸ªåŸºç¡€åº“ï¼Œä¸è¿‡åœ¨ babel ä¸­ä¹Ÿä¼šæœ‰ä¸€äº›ä¸Šå±‚çš„å°è£…ï¼ŒåŒ…æ‹¬ï¼š

- [@babel/polyfill](https://babeljs.io/docs/en/babel-polyfill)
- [@babel/runtime](https://babeljs.io/docs/en/babel-runtime)
- [@babel/runtime-corejs2](https://babeljs.io/docs/en/babel-runtime-corejs2)
- [@babel/runtime-corejs3](https://babeljs.io/docs/en/babel-runtime-corejs3)çœ‹ä¼¼å„ç§è¿è¡Œæ—¶åº“çœ¼èŠ±ç¼­ä¹±ï¼Œå…¶å®éƒ½æ˜¯`core-js`å’Œ`regenerator-runtime`ä¸åŒç‰ˆæœ¬çš„å°è£…ç½¢äº†(`@babel/runtime`æ˜¯ä¸ªç‰¹ä¾‹ï¼Œä¸åŒ…å« core-js çš„ Polyfill)ã€‚è¿™ç±»åº“æ˜¯é¡¹ç›®è¿è¡Œæ—¶å¿…é¡»è¦ä½¿ç”¨åˆ°çš„ï¼Œå› æ­¤ä¸€å®šè¦æ”¾åˆ°`package.json`ä¸­çš„`dependencies`ä¸­ï¼

### 2.2. å®é™…ä½¿ç”¨

äº†è§£äº†åŸºæœ¬æ¦‚å¿µåï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥é€šè¿‡ä»£ç å®æ“çš„æ–¹å¼æ¥å­¦ä¹ è¿™äº›å·¥å…·ï¼Œä»£ç æˆ‘ä¹Ÿå·²ç»æ”¾åˆ°äº†[ä»“åº“](https://github.com/sanyuan0704/juejin-book-vite/tree/main/polyfill/babel-test)ä¸­ï¼Œä½ å¯ä»¥å¯¹ç…§å­¦ä¹ ã€‚

å¦‚æœä½ æ²¡æ‹‰å–ä»“åº“çš„ä»£ç ï¼Œå¯ä»¥å…ˆæŒ‰ç…§å¦‚ä¸‹çš„å‘½ä»¤åˆå§‹åŒ–é¡¹ç›®:

```bash
mkdir babel-test
npm init -y
```

ç„¶åå®‰è£…ä¸€äº›å¿…è¦çš„ä¾èµ–:

pnpm i @babel/cli @babel/core @babel/preset-env

æˆ‘è§£é‡Šä¸€ä¸‹å„ä¸ªä¾èµ–çš„ä½œç”¨:

- `@babel/cli`: ä¸º babel å®˜æ–¹çš„è„šæ‰‹æ¶å·¥å…·ï¼Œå¾ˆé€‚åˆæˆ‘ä»¬ç»ƒä¹ ç”¨ã€‚
- `@babel/core`: babel æ ¸å¿ƒç¼–è¯‘åº“ã€‚
- `@babel/preset-env`: babel çš„é¢„è®¾å·¥å…·é›†ï¼ŒåŸºæœ¬ä¸º babel å¿…è£…çš„åº“ã€‚

æ¥ç€æ–°å»º `src` ç›®å½•ï¼Œåœ¨ç›®å½•ä¸‹å¢åŠ `index.js`æ–‡ä»¶:

```javascript
const func = async () => {
  console.log(12123)
}

Promise.resolve().finally();
```

ä½ å¯ä»¥çœ‹åˆ°ï¼Œç¤ºä¾‹ä»£ç ä¸­æ—¢åŒ…å«äº†`é«˜çº§è¯­æ³•`ä¹ŸåŒ…å«ç°ä»£æµè§ˆå™¨çš„`API`ï¼Œæ­£å¥½å¯ä»¥é’ˆå¯¹è¯­æ³•é™çº§å’Œ Polyfill æ³¨å…¥ä¸¤ä¸ªåŠŸèƒ½è¿›è¡Œæµ‹è¯•ã€‚

æ¥ä¸‹æ¥æ–°å»º`.babelrc.json`å³ babel çš„é…ç½®æ–‡ä»¶ï¼Œå†…å®¹å¦‚ä¸‹:

```json
{
  "presets": [
    [
      "@babel/preset-env", 
      {
        // æŒ‡å®šå…¼å®¹çš„æµè§ˆå™¨ç‰ˆæœ¬
        "targets": {
          "ie": "11"
        },
        // åŸºç¡€åº“ core-js çš„ç‰ˆæœ¬ï¼Œä¸€èˆ¬æŒ‡å®šä¸ºæœ€æ–°çš„å¤§ç‰ˆæœ¬
        "corejs": 3,
        // Polyfill æ³¨å…¥ç­–ç•¥ï¼Œåæ–‡è¯¦ç»†ä»‹ç»
        "useBuiltIns": "usage",
        // ä¸å°† ES æ¨¡å—è¯­æ³•è½¬æ¢ä¸ºå…¶ä»–æ¨¡å—è¯­æ³•
        "modules": false
      }
    ]
  ]
}
```

å…¶ä¸­æœ‰ä¸¤ä¸ªæ¯”è¾ƒå…³é”®çš„é…ç½®: `targets`å’Œ`usage`ã€‚

æˆ‘ä»¬å¯ä»¥é€šè¿‡ `targets` å‚æ•°æŒ‡å®šè¦å…¼å®¹çš„æµè§ˆå™¨ç‰ˆæœ¬ï¼Œä½ æ—¢å¯ä»¥å¡«å¦‚ä¸Šé…ç½®æ‰€ç¤ºçš„ä¸€ä¸ªå¯¹è±¡:

```json
{
  "targets": {
    "ie": "11"
  }
}
```

ä¹Ÿå¯ä»¥ç”¨ [Browserslist](https://github.com/browserslist/browserslist) é…ç½®è¯­æ³•:

```plain
{ 
  // ie ä¸ä½äº 11 ç‰ˆæœ¬ï¼Œå…¨çƒè¶…è¿‡ 0.5% ä½¿ç”¨ï¼Œä¸”è¿˜åœ¨ç»´æŠ¤æ›´æ–°çš„æµè§ˆå™¨
  "targets": "ie >= 11, > 0.5%, not dead"
}
```

Browserslist æ˜¯ä¸€ä¸ªå¸®åŠ©æˆ‘ä»¬è®¾ç½®ç›®æ ‡æµè§ˆå™¨çš„å·¥å…·ï¼Œä¸å…‰æ˜¯ Babel ç”¨åˆ°ï¼Œå…¶ä»–çš„ç¼–è¯‘å·¥å…·å¦‚`postcss-preset-env`ã€`autoprefix`ä¸­éƒ½æœ‰æ‰€åº”ç”¨ã€‚å¯¹äº`Browserslist`çš„é…ç½®å†…å®¹ï¼Œä½ æ—¢å¯ä»¥æ”¾åˆ° Babel è¿™ç§ç‰¹å®šå·¥å…·å½“ä¸­ï¼Œä¹Ÿå¯ä»¥åœ¨`package.json`ä¸­é€šè¿‡`browserslist`å£°æ˜:

```json
// package.json
{ 
  "browserslist": "ie >= 11"
}
```

æˆ–è€…é€šè¿‡`.browserslistrc`è¿›è¡Œå£°æ˜:

```plain
// .browserslistrc
ie >= 11
```

åœ¨å®é™…çš„é¡¹ç›®ä¸­ï¼Œä¸€èˆ¬æˆ‘ä»¬å¯ä»¥å°†ä½¿ç”¨ä¸‹é¢è¿™äº›**æœ€ä½³å®è·µé›†åˆ**æ¥æè¿°ä¸åŒçš„æµè§ˆå™¨ç±»å‹ï¼Œå‡è½»é…ç½®è´Ÿæ‹…:

```plain
// ç°ä»£æµè§ˆå™¨
last 2 versions and since 2018 and > 0.5%
// å…¼å®¹ä½ç‰ˆæœ¬ PC æµè§ˆå™¨
IE >= 11, > 0.5%, not dead
// å…¼å®¹ä½ç‰ˆæœ¬ç§»åŠ¨ç«¯æµè§ˆå™¨
iOS >= 9, Android >= 4.4, last 2 versions, > 0.2%, not dead
```

å¯¹äºè¿™äº›é…ç½®å¯¹åº”çš„å…·ä½“æµè§ˆå™¨åˆ—è¡¨ï¼Œå¤§å®¶å¯ä»¥å» https://browserslist.dev ç«™ç‚¹æŸ¥çœ‹:

![img](./assets/1745592661872-3725df3c-6c24-45a2-8291-b434fcff4a4d.png)

å¥½ï¼Œåœ¨è¯´æ˜äº†ç›®æ ‡æµè§ˆå™¨çš„é…ç½®ä¹‹åï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹å¦å¤–ä¸€ä¸ªé‡è¦çš„é…ç½®â€”â€”`useBuiltIns`ï¼Œå®ƒå†³å®šäº†æ·»åŠ  Polyfill ç­–ç•¥ï¼Œé»˜è®¤æ˜¯ `false`ï¼Œå³ä¸æ·»åŠ ä»»ä½•çš„ Polyfillã€‚ä½ å¯ä»¥æ‰‹åŠ¨å°†`useBuiltIns`é…ç½®ä¸º`entry`æˆ–è€…`usage`ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬çœ‹çœ‹è¿™ä¸¤ä¸ªé…ç½®ç©¶ç«Ÿæœ‰ä»€ä¹ˆåŒºåˆ«ã€‚

é¦–å…ˆä½ å¯ä»¥å°†è¿™ä¸ªå­—æ®µé…ç½®ä¸º`entry`ï¼Œéœ€è¦æ³¨æ„çš„æ˜¯ï¼Œ`entry`é…ç½®è§„å®šä½ å¿…é¡»åœ¨å…¥å£æ–‡ä»¶æ‰‹åŠ¨æ·»åŠ ä¸€è¡Œè¿™æ ·çš„ä»£ç :

```javascript
// index.js å¼€å¤´åŠ ä¸Š
import 'core-js';
```

æ¥ç€åœ¨ç»ˆç«¯æ‰§è¡Œä¸‹é¢çš„å‘½ä»¤è¿›è¡Œ Babel ç¼–è¯‘:

```bash
npx babel src --out-dir dist
```

äº§ç‰©è¾“å‡ºåœ¨`dist`ç›®å½•ä¸­ï¼Œä½ å¯ä»¥å»è§‚å¯Ÿä¸€ä¸‹äº§ç‰©çš„ä»£ç :

![img](./assets/1745592661845-31f19ff5-5735-4ca2-9230-54d9a8794312.png)

Babel å·²ç»æ ¹æ®`ç›®æ ‡æµè§ˆå™¨`çš„é…ç½®ä¸ºæˆ‘ä»¬æ·»åŠ äº†å¤§é‡çš„ Polyfill ä»£ç ï¼Œ`index.js`æ–‡ä»¶ç®€å•çš„å‡ è¡Œä»£ç è¢«ç¼–è¯‘æˆè¿‘ 300 è¡Œã€‚å®é™…ä¸Šï¼ŒBabel æ‰€åšçš„äº‹æƒ…å°±æ˜¯å°†ä½ çš„`import "core-js"`ä»£ç æ›¿æ¢æˆäº†äº§ç‰©ä¸­çš„è¿™äº›å…·ä½“æ¨¡å—çš„å¯¼å…¥ä»£ç ã€‚

ä½†è¿™ä¸ªé…ç½®æœ‰ä¸€ä¸ªé—®é¢˜ï¼Œå³æ— æ³•åšåˆ°æŒ‰éœ€å¯¼å…¥ï¼Œä¸Šé¢çš„äº§ç‰©ä»£ç å…¶å®æœ‰å¤§éƒ¨åˆ†çš„ Polyfill çš„ä»£ç æˆ‘ä»¬å¹¶æ²¡æœ‰ç”¨åˆ°ã€‚æ¥ä¸‹æ¥æˆ‘ä»¬è¯•è¯•`useBuiltIns: usage`è¿™ä¸ªæŒ‰éœ€å¯¼å…¥çš„é…ç½®ï¼Œæ”¹åŠ¨é…ç½®åæ‰§è¡Œç¼–è¯‘å‘½ä»¤:

```bash
npx babel src --out-dir dist
```

åŒæ ·å¯ä»¥çœ‹åˆ°äº§ç‰©è¾“å‡ºåœ¨äº†`dist/index.js`ä¸­ï¼Œå†…å®¹å¦‚ä¸‹æ‰€ç¤º:

![img](./assets/1745592661861-95e72a17-78aa-449b-8856-98a5adf4d4a6.png)

Polyfill ä»£ç ä¸»è¦æ¥è‡ª `corejs` å’Œ `regenerator-runtime`ï¼Œå› æ­¤å¦‚æœè¦è¿è¡Œèµ·æ¥ï¼Œå¿…é¡»è¦è£…è¿™ä¸¤ä¸ªåº“ã€‚

å¯ä»¥å‘ç° Polyfill çš„ä»£ç ç²¾ç®€äº†è®¸å¤šï¼ŒçœŸæ­£åœ°å®ç°äº†æŒ‰éœ€ Polyfill å¯¼å…¥ã€‚å› æ­¤ï¼Œåœ¨å®é™…çš„ä½¿ç”¨å½“ä¸­ï¼Œè¿˜æ˜¯æ¨èå¤§å®¶å°½é‡ä½¿ç”¨`useBuiltIns: "usage"`ï¼Œè¿›è¡ŒæŒ‰éœ€çš„ Polyfill æ³¨å…¥ã€‚

æˆ‘ä»¬æ¥æ¢³ç†ä¸€ä¸‹ï¼Œä¸Šé¢æˆ‘ä»¬åˆ©ç”¨`@babel/preset-env`è¿›è¡Œäº†ç›®æ ‡æµè§ˆå™¨è¯­æ³•çš„é™çº§å’Œ`Polyfill`æ³¨å…¥ï¼ŒåŒæ—¶ç”¨åˆ°äº†`core-js`å’Œ`regenerator-runtime`ä¸¤ä¸ªæ ¸å¿ƒçš„è¿è¡Œæ—¶åº“ã€‚ä½†`@babel/preset-env` çš„æ–¹æ¡ˆä¹Ÿå­˜åœ¨ä¸€å®šå±€é™æ€§:

1. å¦‚æœä½¿ç”¨æ–°ç‰¹æ€§ï¼Œå¾€å¾€æ˜¯é€šè¿‡åŸºç¡€åº“(å¦‚ core-js)å¾€å…¨å±€ç¯å¢ƒæ·»åŠ  Polyfillï¼Œå¦‚æœæ˜¯å¼€å‘åº”ç”¨æ²¡æœ‰ä»»ä½•é—®é¢˜ï¼Œå¦‚æœæ˜¯å¼€å‘ç¬¬ä¸‰æ–¹å·¥å…·åº“ï¼Œåˆ™å¾ˆå¯èƒ½ä¼šå¯¹**å…¨å±€ç©ºé—´é€ æˆæ±¡æŸ“**ã€‚
2. å¾ˆå¤šå·¥å…·å‡½æ•°çš„å®ç°ä»£ç (å¦‚ä¸Šé¢ç¤ºä¾‹ä¸­çš„`_defineProperty`æ–¹æ³•)ï¼Œä¼šåœ¨è®¸å¤šæ–‡ä»¶ä¸­é‡ç°å‡ºç°ï¼Œé€ æˆ**æ–‡ä»¶ä½“ç§¯å†—ä½™**ã€‚

### 2.3. æ›´ä¼˜çš„ Polyfill æ³¨å…¥æ–¹æ¡ˆ: transform-runtime

æ¥ä¸‹æ¥è¦ä»‹ç»çš„`transform-runtime`æ–¹æ¡ˆï¼Œå°±æ˜¯ä¸ºäº†è§£å†³`@babel/preset-env`çš„ç§ç§å±€é™æ€§ã€‚

éœ€è¦æå‰è¯´æ˜çš„æ˜¯ï¼Œ`transform-runtime`æ–¹æ¡ˆå¯ä»¥ä½œä¸º`@babel/preset-env`ä¸­`useBuiltIns`é…ç½®çš„æ›¿ä»£å“ï¼Œä¹Ÿå°±æ˜¯è¯´ï¼Œä¸€æ—¦ä½¿ç”¨`transform-runtime`æ–¹æ¡ˆï¼Œä½ åº”è¯¥æŠŠ`useBuiltIns`å±æ€§è®¾ä¸º `false`ã€‚

æ¥ä¸‹æ¥æˆ‘ä»¬æ¥å°è¯•ä¸€ä¸‹è¿™ä¸ªæ–¹æ¡ˆï¼Œé¦–å…ˆå®‰è£…å¿…è¦çš„ä¾èµ–:

```bash
pnpm i @babel/plugin-transform-runtime -D
pnpm i @babel/runtime-corejs3 -S
```

æˆ‘è§£é‡Šä¸€ä¸‹è¿™ä¸¤ä¸ªä¾èµ–çš„ä½œç”¨: å‰è€…æ˜¯ç¼–è¯‘æ—¶å·¥å…·ï¼Œç”¨æ¥è½¬æ¢è¯­æ³•å’Œæ·»åŠ  Polyfillï¼Œåè€…æ˜¯è¿è¡Œæ—¶åŸºç¡€åº“ï¼Œå°è£…äº†`core-js`ã€`regenerator-runtime`å’Œå„ç§è¯­æ³•è½¬æ¢ç”¨åˆ°çš„`å·¥å…·å‡½æ•°`ã€‚

core-js æœ‰ä¸‰ç§äº§ç‰©ï¼Œåˆ†åˆ«æ˜¯`core-js`ã€`core-js-pure`å’Œ`core-js-bundle`ã€‚ç¬¬ä¸€ç§æ˜¯å…¨å±€ Polyfill çš„åšæ³•ï¼Œ@babel/preset-env å°±æ˜¯ç”¨çš„è¿™ç§äº§ç‰©ï¼›ç¬¬äºŒç§ä¸ä¼šæŠŠ Polyfill æ³¨å…¥åˆ°å…¨å±€ç¯å¢ƒï¼Œå¯ä»¥æŒ‰éœ€å¼•å…¥ï¼›ç¬¬ä¸‰ç§æ˜¯æ‰“åŒ…å¥½çš„ç‰ˆæœ¬ï¼ŒåŒ…å«æ‰€æœ‰çš„ Polyfillï¼Œä¸å¤ªå¸¸ç”¨ã€‚`@babel/runtime-corejs3` ä½¿ç”¨çš„æ˜¯ç¬¬äºŒç§äº§ç‰©ã€‚

æ¥ç€æˆ‘ä»¬å¯¹`.babelrc.json`ä½œå¦‚ä¸‹çš„é…ç½®:

```json
{
  "plugins": [
    // æ·»åŠ  transform-runtime æ’ä»¶
    [
      "@babel/plugin-transform-runtime", 
      {
        "corejs": 3
      }
    ]
  ],
  "presets": [
    [
      "@babel/preset-env", 
      {
        "targets": {
          "ie": "11"
        },
        "corejs": 3,
        // å…³é—­ @babel/preset-env é»˜è®¤çš„ Polyfill æ³¨å…¥
        "useBuiltIns": false,
        "modules": false
      }
    ]
  ]
}
```

æ‰§è¡Œç»ˆç«¯å‘½ä»¤:

```javascript
npx babel src --out-dir dist
```

æˆ‘ä»¬å¯ä»¥å¯¹æ¯”ä¸€ä¸‹ `@babel/preset-env`ä¸‹çš„äº§ç‰©ç»“æœ:

![img](./assets/1745592662292-e179a9a6-db90-4c4b-a198-d6c91bc33be2.png)

ç»è¿‡å¯¹æ¯”æˆ‘ä»¬ä¸éš¾å‘ç°ï¼Œ`transform-runtime` ä¸€æ–¹é¢èƒ½å¤Ÿè®©æˆ‘ä»¬åœ¨ä»£ç ä¸­ä½¿ç”¨`éå…¨å±€ç‰ˆæœ¬`çš„ Polyfillï¼Œè¿™æ ·å°±é¿å…å…¨å±€ç©ºé—´çš„æ±¡æŸ“ï¼Œè¿™ä¹Ÿå¾—ç›Šäº `core-js` çš„ pure ç‰ˆæœ¬äº§ç‰©ç‰¹æ€§ï¼›å¦ä¸€æ–¹é¢å¯¹äº`asyncToGeneator`è¿™ç±»çš„å·¥å…·å‡½æ•°ï¼Œå®ƒä¹Ÿå°†å…¶è½¬æ¢æˆäº†ä¸€æ®µå¼•å…¥è¯­å¥ï¼Œä¸å†å°†å®Œæ•´çš„å®ç°æ”¾åˆ°æ–‡ä»¶ä¸­ï¼ŒèŠ‚çœäº†ç¼–è¯‘åæ–‡ä»¶çš„ä½“ç§¯ã€‚

å¦å¤–ï¼Œ`transform-runtime`æ–¹æ¡ˆå¼•ç”¨çš„åŸºç¡€åº“ä¹Ÿå‘ç”Ÿäº†å˜åŒ–ï¼Œä¸å†æ˜¯ç›´æ¥å¼•å…¥`core-js`å’Œ`regenerator-runtime`ï¼Œè€Œæ˜¯å¼•å…¥`@babel/runtime-corejs3`ã€‚

å¥½ï¼Œä»‹ç»å®Œäº† Babel è¯­æ³•é™çº§ä¸ Polyfill æ³¨å…¥çš„åº•å±‚æ–¹æ¡ˆï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬æ¥çœ‹çœ‹å¦‚ä½•åœ¨ Vite ä¸­åˆ©ç”¨è¿™äº›æ–¹æ¡ˆæ¥è§£å†³ä½ç‰ˆæœ¬æµè§ˆå™¨çš„å…¼å®¹æ€§é—®é¢˜ã€‚

## 3. Vite è¯­æ³•é™çº§ä¸ Polyfill æ³¨å…¥

Vite å®˜æ–¹å·²ç»ä¸ºæˆ‘ä»¬å°è£…å¥½äº†ä¸€ä¸ªå¼€ç®±å³ç”¨çš„æ–¹æ¡ˆ: `@vitejs/plugin-legacy`ï¼Œæˆ‘ä»¬å¯ä»¥åŸºäºå®ƒæ¥è§£å†³é¡¹ç›®è¯­æ³•çš„æµè§ˆå™¨å…¼å®¹é—®é¢˜ã€‚è¿™ä¸ªæ’ä»¶å†…éƒ¨åŒæ ·ä½¿ç”¨ `@babel/preset-env` ä»¥åŠ `core-js`ç­‰ä¸€ç³»åˆ—åŸºç¡€åº“æ¥è¿›è¡Œè¯­æ³•é™çº§å’Œ Polyfill æ³¨å…¥ï¼Œå› æ­¤æˆ‘è§‰å¾—å¯¹äºä¸Šæ–‡æ‰€ä»‹ç»çš„åº•å±‚å·¥å…·é“¾çš„æŒæ¡æ˜¯å¿…è¦çš„ï¼Œå¦åˆ™æ— æ³•ç†è§£æ’ä»¶å†…éƒ¨æ‰€åšçš„äº‹æƒ…ï¼ŒçœŸæ­£é‡åˆ°é—®é¢˜æ—¶å¾€å¾€ä¼šä¸çŸ¥æ‰€æªã€‚

### 3.1. æ’ä»¶ä½¿ç”¨

é¦–å…ˆè®©æˆ‘ä»¬æ¥å®‰è£…ä¸€ä¸‹å®˜æ–¹çš„æ’ä»¶:

```javascript
pnpm i @vitejs/plugin-legacy -D
```

éšååœ¨é¡¹ç›®ä¸­ä½¿ç”¨å®ƒ:

```plain
// vite.config.ts
import legacy from '@vitejs/plugin-legacy';
import { defineConfig } from 'vite'

export default defineConfig({
  plugins: [
    // çœç•¥å…¶å®ƒæ’ä»¶
    legacy({
      // è®¾ç½®ç›®æ ‡æµè§ˆå™¨ï¼Œbrowserslist é…ç½®è¯­æ³•
      targets: ['ie >= 11'],
    })
  ]
})
```

æˆ‘ä»¬åŒæ ·å¯ä»¥é€šè¿‡`targets`æŒ‡å®šç›®æ ‡æµè§ˆå™¨ï¼Œè¿™ä¸ªå‚æ•°åœ¨æ’ä»¶å†…éƒ¨ä¼šé€ä¼ ç»™`@babel/preset-env`ã€‚

åœ¨å¼•å…¥æ’ä»¶åï¼Œæˆ‘ä»¬å¯ä»¥å°è¯•æ‰§è¡Œ`npm run build`å¯¹é¡¹ç›®è¿›è¡Œæ‰“åŒ…ï¼Œå¯ä»¥çœ‹åˆ°å¦‚ä¸‹çš„äº§ç‰©ä¿¡æ¯:

![img](./assets/1745592662316-51cb6586-49a3-46d6-8532-a1f33e9f13e8.png)

ç›¸æ¯”ä¸€èˆ¬çš„æ‰“åŒ…è¿‡ç¨‹ï¼Œå¤šå‡ºäº†`index-legacy.js`ã€`vendor-legacy.js`ä»¥åŠ`polyfills-legacy.js`ä¸‰ä»½äº§ç‰©æ–‡ä»¶ã€‚è®©æˆ‘ä»¬ç»§ç»­è§‚å¯Ÿä¸€ä¸‹`index.html`çš„äº§ç‰©å†…å®¹:

```html
<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <link rel="icon" type="image/svg+xml" href="/assets/favicon.17e50649.svg" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Vite App</title>
    <!-- 1. Modern æ¨¡å¼äº§ç‰© -->
    <script type="module" crossorigin src="/assets/index.c1383506.js"></script>
    <link rel="modulepreload" href="/assets/vendor.0f99bfcc.js">
    <link rel="stylesheet" href="/assets/index.91183920.css">
  </head>
  <body>
    <div id="root"></div>
    <!-- 2. Legacy æ¨¡å¼äº§ç‰© -->
    <script nomodule>å…¼å®¹ iOS nomodule ç‰¹æ€§çš„ polyfillï¼Œçœç•¥å…·ä½“ä»£ç </script>
    <script nomodule id="vite-legacy-polyfill" src="/assets/polyfills-legacy.36fe2f9e.js"></script>
    <script nomodule id="vite-legacy-entry" data-src="/assets/index-legacy.c3d3f501.js">System.import(document.getElementById('vite-legacy-entry').getAttribute('data-src'))</script>
  </body>
</html>
```

é€šè¿‡å®˜æ–¹çš„`legacy`æ’ä»¶ï¼Œ Vite ä¼šåˆ†åˆ«æ‰“åŒ…å‡º`Modern`æ¨¡å¼å’Œ`Legacy`æ¨¡å¼çš„äº§ç‰©ï¼Œç„¶åå°†ä¸¤ç§äº§ç‰©æ’å…¥åŒä¸€ä¸ª HTML é‡Œé¢ï¼Œ`Modern`äº§ç‰©è¢«æ”¾åˆ° `type="module"`çš„ script æ ‡ç­¾ä¸­ï¼Œè€Œ`Legacy`äº§ç‰©åˆ™è¢«æ”¾åˆ°å¸¦æœ‰ [nomodule](https://developer.mozilla.org/en-US/docs/Web/HTML/Element/script#attr-nomodule) çš„ script æ ‡ç­¾ä¸­ã€‚æµè§ˆå™¨çš„åŠ è½½ç­–ç•¥å¦‚ä¸‹å›¾æ‰€ç¤º:

![img](./assets/1745592662645-b6e13dbb-4027-42b3-a75f-3996fa4aa03b.png)

è¿™æ ·äº§ç‰©ä¾¿å°±èƒ½å¤ŸåŒæ—¶æ”¾åˆ°ç°ä»£æµè§ˆå™¨å’Œä¸æ”¯æŒ`type="module"`çš„ä½ç‰ˆæœ¬æµè§ˆå™¨å½“ä¸­æ‰§è¡Œã€‚å½“ç„¶ï¼Œåœ¨å…·ä½“çš„ä»£ç è¯­æ³•å±‚é¢ï¼Œæ’ä»¶è¿˜éœ€è¦è€ƒè™‘è¯­æ³•é™çº§å’Œ Polyfill æŒ‰éœ€æ³¨å…¥çš„é—®é¢˜ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ¥åˆ†æä¸€ä¸‹ Vite çš„å®˜æ–¹`legacy`æ’ä»¶æ˜¯å¦‚ä½•è§£å†³è¿™äº›é—®é¢˜çš„ã€‚

### 3.2. æ’ä»¶æ‰§è¡ŒåŸç†

å®˜æ–¹çš„`legacy`æ’ä»¶æ˜¯ä¸€ä¸ªç›¸å¯¹å¤æ‚åº¦æ¯”è¾ƒé«˜çš„æ’ä»¶ï¼Œç›´æ¥çœ‹æºç å¯èƒ½ä¼šå¾ˆéš¾ç†è§£ï¼Œè¿™é‡Œæˆ‘æ¢³ç†äº†ç”»äº†ä¸€å¼ ç®€åŒ–åçš„æµç¨‹å›¾ï¼Œæ¥ä¸‹æ¥æˆ‘ä»¬å°±æ ¹æ®è¿™å¼ æµç¨‹å›¾æ¥ä¸€ä¸€æ‹†è§£è¿™ä¸ªæ’ä»¶åœ¨å„ä¸ªé’©å­é˜¶æ®µåˆ°åº•åšäº†äº›ä»€ä¹ˆã€‚

![img](./assets/1745592662433-240bcd19-cec9-44aa-83c5-bd046475e6e3.png)

é¦–å…ˆæ˜¯åœ¨`configResolved`é’©å­ä¸­è°ƒæ•´äº†`output`å±æ€§ï¼Œè¿™ä¹ˆåšçš„ç›®çš„æ˜¯è®© Vite åº•å±‚ä½¿ç”¨çš„æ‰“åŒ…å¼•æ“ Rollup èƒ½å¦å¤–æ‰“åŒ…å‡ºä¸€ä»½`Legacy æ¨¡å¼`çš„äº§ç‰©ï¼Œå®ç°ä»£ç å¦‚ä¸‹:

```javascript
const createLegacyOutput = (options = {}) => {
  return {
    ...options,
    // system æ ¼å¼äº§ç‰©
    format: 'system',
    // è½¬æ¢æ•ˆæœ: index.[hash].js -> index-legacy.[hash].js
    entryFileNames: getLegacyOutputFileName(options.entryFileNames),
    chunkFileNames: getLegacyOutputFileName(options.chunkFileNames)
  }
}

const { rollupOptions } = config.build
const { output } = rollupOptions
if (Array.isArray(output)) {
  rollupOptions.output = [...output.map(createLegacyOutput), ...output]
} else {
  rollupOptions.output = [createLegacyOutput(output), output || {}]
}
```

æ¥ç€ï¼Œåœ¨`renderChunk`é˜¶æ®µï¼Œæ’ä»¶ä¼šå¯¹ Legacy æ¨¡å¼äº§ç‰©è¿›è¡Œè¯­æ³•è½¬è¯‘å’Œ Polyfill æ”¶é›†ï¼Œå€¼å¾—æ³¨æ„çš„æ˜¯ï¼Œè¿™é‡Œå¹¶ä¸ä¼šçœŸæ­£æ³¨å…¥`Polyfill`ï¼Œè€Œä»…ä»…åªæ˜¯æ”¶é›†`Polyfill`ï¼Œ:

```javascript
{
  renderChunk(raw, chunk, opts) {
    // 1. ä½¿ç”¨ babel + @babel/preset-env è¿›è¡Œè¯­æ³•è½¬æ¢ä¸ Polyfill æ³¨å…¥
    // 2. ç”±äºæ­¤æ—¶å·²ç»æ‰“åŒ…åçš„ Chunk å·²ç»ç”Ÿæˆ
    //   è¿™é‡Œéœ€è¦å»æ‰ babel æ³¨å…¥çš„ import è¯­å¥ï¼Œå¹¶è®°å½•æ‰€éœ€çš„ Polyfill
    // 3. æœ€åçš„ Polyfill ä»£ç å°†ä¼šåœ¨ generateBundle é˜¶æ®µç”Ÿæˆ
  }
}
```

ç”±äºåœºæ™¯æ˜¯åº”ç”¨æ‰“åŒ…ï¼Œè¿™é‡Œç›´æ¥ä½¿ç”¨ @babel/preset-env çš„`useBuiltIns: 'usage'`æ¥è¿›è¡Œå…¨å±€ Polyfill çš„æ”¶é›†æ˜¯æ¯”è¾ƒæ ‡å‡†çš„åšæ³•ã€‚

å›åˆ° Vite æ„å»ºçš„ä¸»æµç¨‹ä¸­ï¼Œæ¥ä¸‹æ¥ä¼šè¿›å…¥`generateChunk`é’©å­é˜¶æ®µï¼Œç°åœ¨ Vite ä¼šå¯¹ä¹‹å‰æ”¶é›†åˆ°çš„`Polyfill`è¿›è¡Œç»Ÿä¸€çš„æ‰“åŒ…ï¼Œå®ç°ä¹Ÿæ¯”è¾ƒç²¾å¦™ï¼Œä¸»è¦é€»è¾‘é›†ä¸­åœ¨`buildPolyfillChunk`å‡½æ•°ä¸­:

```javascript
// æ‰“åŒ… Polyfill ä»£ç 
async function buildPolyfillChunk(
  name,
  imports
  bundle,
  facadeToChunkMap,
  buildOptions,
  externalSystemJS
) {
  let { minify, assetsDir } = buildOptions
  minify = minify ? 'terser' : false
  // è°ƒç”¨ Vite çš„ build API è¿›è¡Œæ‰“åŒ…
  const res = await build({
    // æ ¹è·¯å¾„è®¾ç½®ä¸ºæ’ä»¶æ‰€åœ¨ç›®å½•
    // ç”±äºæ’ä»¶çš„ä¾èµ–åŒ…å«`core-js`ã€`regenerator-runtime`è¿™äº›è¿è¡Œæ—¶åŸºç¡€åº“
    // å› æ­¤è¿™é‡Œ Vite å¯ä»¥æ­£å¸¸è§£æåˆ°åŸºç¡€ Polyfill åº“çš„è·¯å¾„
    root: __dirname,
    write: false,
    // è¿™é‡Œçš„æ’ä»¶å®ç°äº†ä¸€ä¸ªè™šæ‹Ÿæ¨¡å—
    // Vite å¯¹äº polyfillId ä¼šè¿”å›æ‰€æœ‰ Polyfill çš„å¼•å…¥è¯­å¥
    plugins: [polyfillsPlugin(imports, externalSystemJS)],
    build: {
      rollupOptions: {
        // è®¿é—® polyfillId
        input: {
          // name æš‚å¯è§†ä½œ`polyfills-legacy`
          // pofyfillId ä¸ºä¸€ä¸ªè™šæ‹Ÿæ¨¡å—ï¼Œç»è¿‡æ’ä»¶å¤„ç†åä¼šæ‹¿åˆ°æ‰€æœ‰ Polyfill çš„å¼•å…¥è¯­å¥
          [name]: polyfillId
        },
      }
    }
  });
  // æ‹¿åˆ° polyfill äº§ç‰© chunk
  const _polyfillChunk = Array.isArray(res) ? res[0] : res
  if (!('output' in _polyfillChunk)) return
  const polyfillChunk = _polyfillChunk.output[0]
  // åç»­åšä¸¤ä»¶äº‹æƒ…:
  // 1. è®°å½• polyfill chunk çš„æ–‡ä»¶åï¼Œæ–¹ä¾¿åç»­æ’å…¥åˆ° Modern æ¨¡å¼äº§ç‰©çš„ HTML ä¸­ï¼›
  // 2. åœ¨ bundle å¯¹è±¡ä¸Šæ‰‹åŠ¨æ·»åŠ  polyfill çš„ chunkï¼Œä¿è¯äº§ç‰©å†™åˆ°ç£ç›˜ä¸­
}
```

å› æ­¤ï¼Œä½ å¯ä»¥ç†è§£ä¸ºè¿™ä¸ªå‡½æ•°çš„ä½œç”¨å³é€šè¿‡ `vite build` å¯¹`renderChunk`ä¸­æ”¶é›†åˆ° polyfill ä»£ç è¿›è¡Œæ‰“åŒ…ï¼Œç”Ÿæˆä¸€ä¸ªå•ç‹¬çš„ chunk:

![img](./assets/1745592663141-fc91a6d8-369f-44bf-9656-b1494986ac69.png)

éœ€è¦æ³¨æ„çš„æ˜¯ï¼Œpolyfill chunk ä¸­é™¤äº†åŒ…å«ä¸€äº› core-js å’Œ regenerator-runtime çš„ç›¸å…³ä»£ç ï¼Œä¹ŸåŒ…å«äº† `SystemJS` çš„å®ç°ä»£ç ï¼Œä½ å¯ä»¥å°†å…¶ç†è§£ä¸º ESM çš„åŠ è½½å™¨ï¼Œå®ç°äº†åœ¨æ—§ç‰ˆæµè§ˆå™¨ä¸‹çš„æ¨¡å—åŠ è½½èƒ½åŠ›ã€‚

ç°åœ¨æˆ‘ä»¬å·²ç»èƒ½å¤Ÿæ‹¿åˆ° Legacy æ¨¡å¼çš„äº§ç‰©æ–‡ä»¶ååŠ Polyfill Chunk çš„æ–‡ä»¶åï¼Œé‚£ä¹ˆå°±å¯ä»¥é€šè¿‡`transformIndexHtml`é’©å­æ¥å°†è¿™äº›äº§ç‰©æ’å…¥åˆ° HTML çš„ç»“æ„ä¸­:

```plain
{
  transformIndexHtml(html) {
    // 1. æ’å…¥ Polyfill chunk å¯¹åº”çš„ <script nomodule> æ ‡ç­¾
    // 2. æ’å…¥ Legacy äº§ç‰©å…¥å£æ–‡ä»¶å¯¹åº”çš„ <script nomodule> æ ‡ç­¾
  }
}
```

OKï¼ŒVite å®˜æ–¹çš„ legacy æ’ä»¶çš„ä¸»è¦åŸç†å°±ä»‹ç»åˆ°è¿™é‡Œï¼Œä¸ºäº†æ–¹ä¾¿å¤§å®¶ç†è§£ï¼Œè®²è§£çš„è¿‡ç¨‹ä¸­å¿½ç•¥äº†ä¸€äº›ä¸ä¸»æµç¨‹å…³è”ä¸å¤§çš„ç»†èŠ‚ï¼Œæœ€åç»™å¤§å®¶è¡¥å……ä¸€ä¸‹ï¼Œæ„Ÿå…´è¶£çš„åŒå­¦å¯ä»¥ç»§ç»­æ·±å…¥å­¦ä¹ :

- å½“æ’ä»¶å‚æ•°ä¸­å¼€å¯äº†`modernPolyfills`é€‰é¡¹æ—¶ï¼ŒVite ä¹Ÿä¼šè‡ªåŠ¨å¯¹ Modern æ¨¡å¼çš„äº§ç‰©è¿›è¡Œ Polyfill æ”¶é›†ï¼Œå¹¶å•ç‹¬æ‰“åŒ…æˆ`polyfills-modern.js`çš„ chunkï¼ŒåŸç†å’Œ Legacy æ¨¡å¼ä¸‹å¤„ç† Polyfill ä¸€æ ·ã€‚
- Sarari 10.1 ç‰ˆæœ¬ä¸æ”¯æŒ `nomodule`ï¼Œä¸ºæ­¤éœ€è¦å•ç‹¬å¼•å…¥ä¸€äº›è¡¥ä¸ä»£ç ï¼Œ[ç‚¹å‡»æŸ¥çœ‹](https://gist.github.com/samthor/64b114e4a4f539915a95b91ffd340acc)ã€‚
- éƒ¨åˆ†ä½ç‰ˆæœ¬ Edge æµè§ˆå™¨è™½ç„¶æ”¯æŒ type="module"ï¼Œä½†ä¸æ”¯æŒåŠ¨æ€ importï¼Œä¸ºæ­¤ä¹Ÿéœ€è¦æ’å…¥ä¸€äº›[è¡¥ä¸ä»£ç ](https://github.com/vitejs/vite/pull/3885)ï¼Œé’ˆå¯¹è¿™ç§æƒ…å†µä¸‹é™çº§ä½¿ç”¨ Legacy æ¨¡å¼çš„äº§ç‰©ã€‚

## 4. å°ç»“

æ­å–œä½ ï¼Œå­¦ä¹ å®Œäº†æœ¬èŠ‚çš„å†…å®¹ï¼æœ¬èŠ‚ä¸»è¦è®²è§£äº† Vite ä¸­è¯­æ³•é™çº§ä¸ Polyfill ç›¸å…³çš„å†…å®¹ï¼Œæ¶‰åŠçš„æ¦‚å¿µæ¯”è¾ƒå¤šï¼Œç¯‡å¹…ä¹Ÿæ¯”è¾ƒé•¿ï¼Œä½ éœ€è¦é‡ç‚¹æŒæ¡ä»¥ä¸‹å†…å®¹:

1. `@babel/preset-env` çš„ä½¿ç”¨ã€‚
2. `useBuiltIns` ä¸ `transformRuntime` ä¸¤ç§ Polyfill æ–¹æ¡ˆçš„åŒºåˆ«ã€‚
3. Vite é™çº§æ’ä»¶`@vitejs/plugin-legacy` çš„ä½¿ç”¨åŠåŸç†ã€‚

é¦–å…ˆæˆ‘ç»™ä½ å¤ç°äº†çº¿ä¸Šçš„ä½ç‰ˆæœ¬æµè§ˆå™¨è¯­æ³•æŠ¥é”™æƒ…æ™¯ï¼Œä¸»è¦åˆ†ä¸º **è¯­æ³•æŠ¥é”™**å’Œ **Polyfill ç¼ºå¤±** çš„é—®é¢˜ï¼Œç”±æ­¤å¼•å‡ºäº†åº•å±‚çš„è§£å†³æ–¹æ¡ˆâ€”â€”ä½¿ç”¨ `Babel ç¼–è¯‘å·¥å…·é“¾` å’Œ JS è¿è¡Œæ—¶åŸºç¡€åº“æ¥å®Œæˆã€‚æ¥ç€æˆ‘è·Ÿä½ å…·ä½“ä»‹ç»äº† `@babel/preset-env`çš„ä½¿ç”¨ï¼Œé€šè¿‡å®é™…çš„ä»£ç æ¡ˆä¾‹è®©ä½ ä½“éªŒäº†å®ƒçš„è¯­æ³•é™çº§å’Œè‡ªåŠ¨ Polyfill æ³¨å…¥çš„èƒ½åŠ›ï¼Œæ¥ç€ï¼Œæˆ‘åˆç»™ä½ ä»‹ç»äº†ä¸€ä¸ªæ›´ä¼˜çš„ Polyfill æ–¹æ¡ˆâ€”â€”`transform-runtime`æ–¹æ¡ˆï¼Œå¹¶ä¸`@babel/preset-env`çš„`useBuiltIns`æ–¹æ¡ˆè¿›è¡Œäº†å¯¹æ¯”ï¼Œåˆ†æäº†`transform-runtime`æ–¹æ¡ˆçš„ä¸¤ä¸ªä¼˜åŒ–ç‚¹: **ä¸å½±å“å…¨å±€ç©ºé—´**å’Œ**ä¼˜åŒ–æ–‡ä»¶ä½“ç§¯**ã€‚

åœ¨ä»‹ç»äº†åº•å±‚çš„è§£å†³æ–¹æ¡ˆä¹‹åï¼Œæˆ‘ä»¬å¼€å§‹å­¦ä¹ åœ¨ Vite ä¸­çš„è§£å†³æ–¹æ¡ˆâ€”â€”`@vitejs/plugin-legacy`ï¼Œåˆ†æäº†å®ƒå¦‚ä½•è®©äº§ç‰©èƒ½å¤ŸåŒæ—¶å…¼å®¹ç°ä»£æµè§ˆå™¨å’Œä¸æ”¯æŒ `type="module"`çš„ä½ç‰ˆæœ¬æµè§ˆå™¨ï¼Œæ¥ç€æ·±å…¥åœ°è®²è§£äº†è¿™ä¸ªæ’ä»¶çš„å®ç°åŸç†ï¼Œä½ å¯ä»¥å‘ç°åº•å±‚ä¹Ÿæ˜¯é€šè¿‡`@babel/preset-env`æ¥å®Œæˆå…¼å®¹æ–¹æ¡ˆçš„ã€‚

ä»¥ä¸Šå°±æ˜¯æœ¬èŠ‚çš„å…¨éƒ¨å†…å®¹ï¼Œå¸Œæœ›å¯¹ä½ èƒ½æœ‰æ‰€å¯å‘ï¼Œä¹Ÿæ¬¢è¿å°†ä½ çš„å­¦ä¹ å¿ƒå¾—å’Œå›°æƒ‘æ‰“åœ¨è¯„è®ºåŒºï¼Œæˆ‘ä»¬ä¸‹ä¸€å°èŠ‚å†è§ğŸ‘‹ğŸ»

